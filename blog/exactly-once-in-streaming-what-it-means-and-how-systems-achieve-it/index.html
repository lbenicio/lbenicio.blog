<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><title>Exactly-Once in Streaming: What It Means and How Systems Achieve It · Leonardo Benicio</title><meta name=description content="Disentangle marketing from mechanisms: idempotence, transactions, and state snapshots behind ‘exactly-once’."><link rel=alternate type=application/rss+xml title=RSS href=https://lbenicio.dev/index.xml><link rel=canonical href=https://blog.lbenicio.dev/blog/exactly-once-in-streaming-what-it-means-and-how-systems-achieve-it/><link rel=preload href=/static/fonts/OpenSans-Regular.ttf as=font type=font/ttf crossorigin><link rel="stylesheet" href="/assets/css/fonts.min.40e2054b739ac45a0f9c940f4b44ec00c3b372356ebf61440a413c0337c5512e.css" crossorigin="anonymous" integrity="sha256-QOIFS3OaxFoPnJQPS0TsAMOzcjVuv2FECkE8AzfFUS4="><link rel="shortcut icon" href=/static/assets/favicon/favicon.ico><link rel=icon type=image/x-icon href=/static/assets/favicon/favicon.ico><link rel=icon href=/static/assets/favicon/favicon.svg type=image/svg+xml><link rel=icon href=/static/assets/favicon/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=/static/assets/favicon/favicon-16x16.png sizes=16x16 type=image/png><link rel=apple-touch-icon href=/static/assets/favicon/apple-touch-icon.png><link rel=manifest href=/static/assets/favicon/site.webmanifest><link rel=mask-icon href=/static/assets/favicon/safari-pinned-tab.svg color=#209cee><meta name=msapplication-TileColor content="#209cee"><meta name=msapplication-config content="/static/assets/favicon/browserconfig.xml"><meta name=theme-color content="#d2e9f8"><meta property="og:title" content="Exactly-Once in Streaming: What It Means and How Systems Achieve It · Leonardo Benicio"><meta property="og:description" content="Disentangle marketing from mechanisms: idempotence, transactions, and state snapshots behind ‘exactly-once’."><meta property="og:url" content="https://blog.lbenicio.dev/blog/exactly-once-in-streaming-what-it-means-and-how-systems-achieve-it/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.lbenicio.dev/static/assets/images/blog/exactly-once.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Exactly-Once in Streaming: What It Means and How Systems Achieve It · Leonardo Benicio"><meta name=twitter:description content="Disentangle marketing from mechanisms: idempotence, transactions, and state snapshots behind ‘exactly-once’."><meta name=twitter:site content="@lbenicio_"><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"About Leonardo Benicio","url":"https://blog.lbenicio.dev"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Person","name":"Leonardo Benicio","sameAs":["https://github.com/lbenicio","https://www.linkedin.com/in/leonardo-benicio","https://twitter.com/lbenicio_"],"url":"https://blog.lbenicio.dev"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://blog.lbenicio.dev/","name":"Home","position":1},{"@type":"ListItem","item":"https://blog.lbenicio.dev/","name":"Blog","position":2},{"@type":"ListItem","item":"https://blog.lbenicio.dev/blog/exactly-once-in-streaming-what-it-means-and-how-systems-achieve-it/","name":"Exactly Once in Streaming What It Means and How Systems Achieve It","position":3}]}</script><link rel="stylesheet" href="/assets/css/main.min.1e8a566ac8bc3f0664d0db4ec8a015b07421c33fa11d336a6b914522a9cabf30.css" crossorigin="anonymous" integrity="sha256-6lhUOpwCHMSMROmggsVSp3AHKud6gBrIFGTzl3GV4BY="></head><body class="c6942b3 c03620d cf3bd2e"><script>(function(){try{document.addEventListener("gesturestart",function(e){e.preventDefault()}),document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1});var e=0;document.addEventListener("touchend",function(t){var n=Date.now();n-e<=300&&t.preventDefault(),e=n},{passive:!1})}catch{}})()</script><a href=#content class="cba5854 c21e770 caffa6e cc5f604 cf2c31d cdd44dd c10dda9 c43876e c787e9b cddc2d2 cf55a7b c6dfb1e c9391e2">Skip to content</a>
<script>(function(){try{const e=localStorage.getItem("theme");e==="dark"&&document.documentElement.classList.add("dark");const t=document.querySelector('button[aria-label="Toggle theme"]');t&&t.setAttribute("aria-pressed",String(e==="dark"))}catch{}})();function toggleTheme(e){const s=document.documentElement,t=s.classList.toggle("dark");try{localStorage.setItem("theme",t?"dark":"light")}catch{}try{var n=e&&e.nodeType===1?e:document.querySelector('button[aria-label="Toggle theme"]');n&&n.setAttribute("aria-pressed",String(!!t))}catch{}}(function(){function e(){try{return document.documentElement.classList.contains("dark")?"dark":"light"}catch{return"light"}}function n(t){const n=document.getElementById("i98aca2"),s=document.getElementById("iad2af0"),o=document.getElementById("i975fb5");if(!n||!s||!o)return;try{n.style.transform="translateX(0)",n.style.transition||(n.style.transition="transform 200ms ease-out")}catch{}try{s.hidden=!1,s.style.display="block"}catch{}o.setAttribute("aria-expanded","true"),n.setAttribute("aria-hidden","false");try{document.body.classList.add("c150bbe")}catch{}const i=document.getElementById("i190984");i&&i.focus();try{window.umami&&typeof window.umami.track=="function"&&window.umami.track("mobile_menu_open",{page:location.pathname,theme:e(),source:t||"programmatic"})}catch{}}function t(t){const n=document.getElementById("i98aca2"),s=document.getElementById("iad2af0"),o=document.getElementById("i975fb5");if(!n||!s||!o)return;try{n.style.transform="translateX(100%)",n.style.transition||(n.style.transition="transform 200ms ease-out")}catch{}try{s.hidden=!0,s.style.display="none"}catch{}o.setAttribute("aria-expanded","false"),n.setAttribute("aria-hidden","true");try{document.body.classList.remove("c150bbe")}catch{}o.focus();try{window.umami&&typeof window.umami.track=="function"&&window.umami.track("mobile_menu_close",{page:location.pathname,theme:e(),source:t||"programmatic"})}catch{}}function s(e){e.key==="Escape"&&t("escape")}window.__openMobileMenu=n,window.__closeMobileMenu=t;try{window.addEventListener("keydown",s,!0)}catch{}})()</script><header class="cd019ba c98dfae cdd44dd cfdda01 c9ee25d ce2dc7a cd72dd7 cc0dc37" role=banner><div class="cfdda01 c6942b3 ccf47f4 c7c11d8"><a href=/ class="c87e2b0 c6942b3 c7c11d8 c1838fa cb594e4" aria-label=Home><img src=/static/assets/favicon/favicon.svg alt=Logo width=32 height=32 class="c3de71a c4d5191">
<span class="cf8f011 c4d1253 cbd72bc cd7e69e">Leonardo Benicio</span></a><div class="c6942b3 c85cbd4 c7c11d8 ca798da c1838fa c7a0580"><nav class="cc1689c cd9b445 c75065d c04bab1" aria-label=Main><a href=/ class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Home</a>
<a href=https://lbenicio.dev/about target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">About</a>
<a href=https://lbenicio.dev/timeline target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Timeline</a>
<a href=https://lbenicio.dev/reading target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Reading</a>
<a href=https://publications.lbenicio.dev target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Publications</a>
<a href=https://lbenicio.dev/contact target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Contact</a></nav><button id="i1d73d4" type=button class="c1d6c20 c81ac7c c6a899b c7c11d8 c1d0018 c10dda9 c8e184d c514027 c88daee c7a66a6 c097fa1 cfc01c7 c286dd7 c2bd687 cfdce1d cfef18f" onclick=toggleTheme(this) aria-label="Toggle theme" aria-pressed=false title="Toggle theme">
<svg class="cb26e41 c50ceea cb69a5c c4f45c8 c8c2c40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="cb26e41 c8fca2b cb69a5c c4f45c8 cc1689c c9c27ff" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M6.34 17.66l2.83-2.83"/><path d="M14.83 9.17l2.83-2.83"/></svg>
<span class="cba5854">Toggle theme</span></button><div class="c658bcf c097fa1"><button id="i975fb5" type=button class="c1d6c20 c81ac7c c6a899b c7c11d8 c1d0018 c10dda9 c8e184d c514027 c88daee c7a66a6 cfc01c7 c286dd7 c2bd687 cfdce1d cfef18f" aria-label="Open menu" aria-controls="i98aca2" aria-expanded=false onclick='window.__openMobileMenu("button")' data-d38f920=mobile_menu_open_click>
<svg class="c20e4eb cb58471" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
<span class="cba5854">Open menu</span></button></div></div></div></header><div id="iad2af0" class="caffa6e ce4b5f4 c14639a" style=background-color:hsl(var(--background)) hidden onclick='window.__closeMobileMenu("overlay")' data-d38f920=mobile_menu_overlay_click></div><aside id="i98aca2" class="caffa6e c9efbc5 c437fa9 c49e97e c6c6936 c7cacca c7b34a4 c787e9b c88daee cad071a c6942b3 c03620d" role=dialog aria-modal=true aria-hidden=true aria-label="Mobile navigation" style="transform:translateX(100%);transition:transform 200ms ease-out;will-change:transform"><div class="c6942b3 c7c11d8 c82c52d c5df473 ccf47f4 c9ee25d"><a href=/ class="c6942b3 c7c11d8 c1838fa" aria-label=Home><img src=/static/assets/favicon/favicon.svg alt=Logo width=24 height=24 class="c20e4eb cb58471">
<span class="c62aaf0 c7c1b66 cbd72bc">Leonardo Benicio</span>
</a><button id="i190984" type=button class="c1d6c20 c81ac7c c6a899b c7c11d8 c1d0018 c10dda9 c514027 c286dd7 c2bd687 cfdce1d" aria-label="Close menu" onclick='window.__closeMobileMenu("button")' data-d38f920=mobile_menu_close_click>
<svg class="c16e528 c61f467" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
<span class="cba5854">Close</span></button></div><nav class="c85cbd4 ca0eaa4 c5df473 c6689b9"><ul class="cd69733"><li><a href=/ class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Home</a></li><li><a href=https://lbenicio.dev/about target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>About</a></li><li><a href=https://lbenicio.dev/timeline target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Timeline</a></li><li><a href=https://lbenicio.dev/reading target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Reading</a></li><li><a href=https://publications.lbenicio.dev target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Publications</a></li><li><a href=https://lbenicio.dev/contact target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Contact</a></li></ul></nav><div class="c60a4cc ccdf0e8 c277478 c13044e"><p>&copy; 2026 Leonardo Benicio</p></div></aside><div class="caffa6e c437fa9 ce9aced c97bba6 c15da2a c975cba" role=complementary aria-label="GitHub repository"><div class="c9d056d c252f85 ca22532 ca88a1a c876315"><div class="c6942b3 c7c11d8 c1d0018 cd1fd22 c6066e4 c43876e ce3d5b6 caa20d2 c3ecea6 c0cd2e2 cddc2d2 c3ed5c9 cd4074c c876315"><a href=https://github.com/lbenicio/aboutme target=_blank rel="noopener noreferrer" class="c6942b3 c7c11d8 cd1fd22 c71bae8 cfac1ac c19ee42 c25dc7c cb40739 cbbda39 cf55a7b" aria-label="View source on GitHub"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="cb26e41 c41bcd4 cf17690 cfa4e34 c78d562" aria-hidden="true"><path d="M15 22v-4a4.8 4.8.0 00-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35.0-3.5.0.0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35.0 3.5A5.403 5.403.0 004 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
<span class="cb5c327 cd7e69e">Fork me</span></a></div></div></div><main id="i7eccc0" class="cfdda01 c5df473 c0eecc8 c85cbd4" role=main aria-label=Content><nav class="cb545ce c8d8ae4 c277478" aria-label=Breadcrumb><ol class="c6942b3 c3adaf2 c7c11d8 cd365ee c3ecea6"><li><a href=/ class="c19ee42 c71bae8 cfac1ac">Home</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><a href=/ class="c19ee42 c71bae8 cfac1ac">Blog</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><span class="c88daee">Exactly Once in Streaming What It Means and How Systems Achieve It</span></li></ol></nav><article class="c461ba0 c1c203f cfb6084 c995404 c6ca165"><nav class="cb545ce c8d8ae4 c277478" aria-label=Breadcrumb><ol class="c6942b3 c3adaf2 c7c11d8 cd365ee c3ecea6"><li><a href=/ class="c19ee42 c71bae8 cfac1ac">Home</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><a href=/ class="c19ee42 c71bae8 cfac1ac">Blog</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><span class="c88daee">Exactly Once in Streaming What It Means and How Systems Achieve It</span></li></ol></nav><header class="c8aedc7"><h1 class="cf304bc c6fb0fe cf8f011 cc484e1">Exactly-Once in Streaming: What It Means and How Systems Achieve It</h1><div class="c277478 c3ecea6 c8fb24a">2025-01-22
· Leonardo Benicio</div><div class="c1a1a3f c8124f2"><img src=/static/assets/images/blog/exactly-once.png alt class="cfdda01 c524300 c677556"></div><p class="lead c3ecea6">Disentangle marketing from mechanisms: idempotence, transactions, and state snapshots behind ‘exactly-once’.</p></header><div class="content"><p>&ldquo;Exactly-once&rdquo; doesn’t mean an event packet traverses the network a single time. It means that in the <em>observable</em> outputs (state, emitted records, external side effects) each logical input is reflected <strong>at most once</strong> and <strong>at least once</strong>—so exactly once—despite retries, replays, failovers, or speculative execution. It is an <em>end-to-end</em> property requiring cooperation across producer, broker, processing engine, and sinks.</p><hr><h2 id="1-taxonomy-of-delivery--processing-guarantees">1. Taxonomy of Delivery & Processing Guarantees</h2><table><thead><tr><th>Term</th><th>Network Delivery</th><th>Processing Attempts</th><th>External Effect Guarantee</th><th>Typical Mechanisms</th></tr></thead><tbody><tr><td>At most once</td><td>Messages may be lost</td><td>≤1</td><td>Missing effects possible</td><td>Fire-and-forget, no ack replay</td></tr><tr><td>At least once</td><td>Redelivery possible</td><td>≥1</td><td>Duplicated effects if not idempotent</td><td>Offsets/checkpoints + replay</td></tr><tr><td>Exactly once (processing)</td><td>Redelivery possible</td><td>≥1</td><td>Each logical record causes effect once</td><td>Idempotence + dedupe or transactions + snapshots</td></tr></tbody></table><p>Note the <em>processing</em> dimension: we usually allow redelivery at the transport layer; the system masks duplicates before they become externally visible.</p><hr><h2 id="2-building-blocks">2. Building Blocks</h2><h3 id="21-idempotent-writes">2.1 Idempotent Writes</h3><p>If applying the same event twice yields the same state as once, duplicates are harmless. Techniques:</p><ol><li>Natural key upsert (primary key overwrite) in a database.</li><li>Commutative/associative aggregation (sums, max, HyperLogLog merges) with careful bounding.</li><li>Deduplication tables (store last processed sequence per key, ignore older/repeated).</li></ol><h3 id="22-sequence-numbers--producer-epochs">2.2 Sequence Numbers & Producer Epochs</h3><p>Kafka’s idempotent producer tags each batch with a monotonic sequence per partition + producer ID. Broker rejects out-of-order duplicates within retention. Crash & restart increments epoch, preventing stale inflight data from being accepted.</p><h3 id="23-transactions">2.3 Transactions</h3><p>Combine multiple writes (e.g., produce to output topics + commit consumer offsets) into an atomic unit. If transaction aborts, offsets aren&rsquo;t committed, so replay reprocesses <em>but</em> earlier partial writes are aborted (invisible). Key idea: <strong>atomic offset commit + output publish</strong>.</p><h3 id="24-state-snapshots--checkpoints">2.4 State Snapshots / Checkpoints</h3><p>Periodic capture of operator state + source position (offsets). After crash, restart from snapshot point and replay from saved input position, ensuring deterministic replay window.</p><h3 id="25-determinism--side-effects">2.5 Determinism & Side Effects</h3><p>Non-deterministic operators (e.g., random numbers, system time) break repeatability unless controlled (seeded RNG, event-time derivations). External side effects (sending emails) must be coordinated (outbox pattern, idempotency tokens) or exactly-once claims degrade to at-least-once with disclaimers.</p><hr><h2 id="3-end-to-end-example-kafka--flink">3. End-to-End Example: Kafka + Flink</h2><p>Flow:</p><ol><li><strong>Source</strong> (Kafka consumer) reads partitions with offsets; includes offsets in barrier alignment snapshots.</li><li><strong>Barrier Injection</strong>: JobManager triggers checkpoint N; sources emit barrier N downstream.</li><li><strong>Operator Alignment</strong>: Each operator buffers upstream channels until receiving barrier N on all, then snapshots keyed state (e.g., RocksDB) + timers.</li><li><strong>Snapshot Storage</strong>: State backend persists state + offset metadata (filesystem / object store).</li><li><strong>Commit</strong>: Once all tasks ack, checkpoint becomes <em>completed</em>; transactional sinks commit their pending transactions for N.</li><li><strong>Failure & Recovery</strong>: Restart tasks load last successful checkpoint, seek Kafka consumers to persisted offsets, reprocess from there only.</li></ol><p>Diagram (conceptual):</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Kafka Partitions --&gt; Source Tasks --barriers--&gt; Map/KeyBy/Window --&gt; Sink (2-phase txn)
</span></span><span style=display:flex><span>             offsets &amp; seq       snapshot(state+offsets)            pre-commit until barrier complete
</span></span></code></pre></div><h3 id="consistency-window">Consistency Window</h3><p>State corresponds <em>exactly</em> to offsets up to the last barrier. Records after that barrier may have been processed speculatively but their outputs held in pending transactions not yet committed, ensuring atomic visibility.</p><hr><h2 id="4-failure-scenarios--resolution">4. Failure Scenarios & Resolution</h2><table><thead><tr><th>Scenario</th><th>Without XA / Idempotence</th><th>With Transactions & Checkpoints</th></tr></thead><tbody><tr><td>Task crash after producing output but before committing offsets</td><td>Duplicate output on replay</td><td>Uncommitted transaction discarded; outputs invisible</td></tr><tr><td>Broker redelivers batch (network glitch)</td><td>Duplicate aggregation</td><td>Sequence numbers dedupe / idempotent merge</td></tr><tr><td>Partial sink batch success</td><td>Split output set</td><td>Atomic commit or outbox ensures all-or-nothing</td></tr><tr><td>Late-arriving event after watermark</td><td>Possibly ignored inconsistently</td><td>Unified watermark & allowed lateness, deterministic side-path</td></tr></tbody></table><hr><h2 id="5-windowing-watermarks--exactly-once">5. Windowing, Watermarks & Exactly-Once</h2><p>Event-time windows close based on <em>watermarks</em> (monotonic progress markers). Exactly-once windowed aggregations require:</p><ol><li>Deterministic assignment of events to windows.</li><li>Snapshot inclusion of partial window state + watermark value.</li><li>Reprocessing after failure reproduces same emission pattern (window triggers) before committing downstream.</li></ol><p>Out-of-order handling (allowed lateness) adds potential retractions. Systems often implement <em>update</em> semantics: a late event triggers recomputation and emission of an updated result (idempotent if downstream keyed by window). Ensure downstream sink overwrites (idempotent upsert) rather than append-only.</p><hr><h2 id="6-sinks-idempotent-vs-transactional">6. Sinks: Idempotent vs. Transactional</h2><table><thead><tr><th>Sink Type</th><th>Strategy</th><th>Pros</th><th>Cons</th></tr></thead><tbody><tr><td>Keyed DB (e.g., Cassandra)</td><td>Upsert by primary key</td><td>Simple, idempotent</td><td>Last-write-wins may hide duplicates</td></tr><tr><td>Object store (files)</td><td>Staging + atomic rename</td><td>Avoid duplicates</td><td>Small file proliferation, eventual consistency</td></tr><tr><td>Kafka topic</td><td>Transactions (produce + offsets)</td><td>End-to-end semantics</td><td>Longer commit latency</td></tr><tr><td>Elastic / Search</td><td>External idempotency key</td><td>Dedup at index layer</td><td>Requires extra key management</td></tr><tr><td>Data warehouse (batch micro-batching)</td><td>Merge-on-read (Delta/Iceberg)</td><td>ACID semantics</td><td>Higher latency</td></tr></tbody></table><hr><h2 id="7-latency-vs-semantics-trade-offs">7. Latency vs. Semantics Trade-offs</h2><p>Lower checkpoint interval ⇒ more overhead (barrier alignment, state snapshot I/O) but less reprocessing on failure. Higher interval reduces steady latency cost but increases <em>rollback distance</em> (amount of work to replay) and potential duplicate output risk if sinks are partially transactional.</p><p>Tuning axes:</p><ol><li><strong>Checkpoint Interval</strong>: start moderate (e.g., 1 min) then measure state size & throughput.</li><li><strong>State Backend</strong>: In-memory backend low latency but volatile; RocksDB durable but adds serialization + compaction overhead.</li><li><strong>Async vs. Sync Commits</strong>: Some sinks support asynchronous pre-commit overlapped with processing; measure end-to-end tail latency (p99) not just mean.</li><li><strong>Batching</strong>: Larger transactional batches amortize overhead but increase recovery replay window.</li></ol><hr><h2 id="8-testing-exactly-once-claims">8. Testing Exactly-Once Claims</h2><p>Checklist:</p><ol><li>Induce failures (SIGKILL task managers) mid-checkpoint; verify no duplicated sink rows.</li><li>Simulate network partitions / broker restarts; confirm sequence gaps not causing lost records.</li><li>Inject duplicate producer sends; ensure downstream aggregate stable.</li><li>Replay from older checkpoints intentionally; verify deterministic output reproduction.</li><li>Time-skew tests: deliver late events within allowed lateness; verify window updates idempotently replace prior results.</li><li>Chaos automation: schedule random process kills + network delays during stress load.</li></ol><p>Metrics to watch: checkpoint duration, bytes snapshotted, barrier alignment time, end-to-end latency distribution, number of aborted vs. committed transactions.</p><hr><h2 id="9-operational-pitfalls">9. Operational Pitfalls</h2><table><thead><tr><th>Pitfall</th><th>Effect</th><th>Mitigation</th></tr></thead><tbody><tr><td>Large RocksDB state compactions align with checkpoints</td><td>Latency spikes / timeout</td><td>Stagger compactions, increase incremental checkpointing</td></tr><tr><td>Slow sink flush extends checkpoint completion time</td><td>Backpressure to sources</td><td>Increase sink parallelism, tune batch size</td></tr><tr><td>Unbounded dedupe tables</td><td>Memory blow-up</td><td>TTL / probabilistic structures (Bloom + index)</td></tr><tr><td>Mixed time semantics (processing vs event time misuse)</td><td>Nondeterministic replays</td><td>Normalize to event time early</td></tr><tr><td>Non-idempotent side-effects (emails)</td><td>Duplicate user impact</td><td>Outbox pattern + idempotency keys</td></tr></tbody></table><hr><h2 id="10-alternative-approaches--emerging-trends">10. Alternative Approaches & Emerging Trends</h2><ol><li><strong>Change Data Capture (CDC) with Upsert Logs</strong>: Instead of stream processor enforcing exactly-once, downstream warehouse merges logs transactionally, shifting complexity.</li><li><strong>Streaming Lakehouse Tables</strong>: Formats like Delta / Iceberg + streaming writers use snapshot isolation + atomic manifest commits to approximate exactly-once ingestion, assuming deterministic partitioning.</li><li><strong>Versioned State Stores</strong>: Multi-version concurrency control (MVCC) in streaming databases enabling rollback consistent with checkpoint snapshots.</li><li><strong>Deterministic Replay Engines</strong>: Systems recording input order (totally ordered logs) + deterministic operator execution can rebuild state <em>precisely</em> without intermediate snapshots (higher storage, lower snapshot overhead).</li><li><strong>Transactional Message Queues</strong>: Some brokers incorporate per-message idempotency tokens reducing need for engine-level dedupe.</li></ol><hr><h2 id="11-cost--resource-considerations">11. Cost & Resource Considerations</h2><p>Exactly-once has <em>taxes</em>:</p><ol><li>Extra bytes for sequence numbers / transactional markers.</li><li>Increased I/O for frequent snapshots (state size × frequency).</li><li>Latency added by barrier alignment (slow partitions drag all).</li><li>Storage for retained checkpoints and changelogs.</li><li>CPU for serialization / RocksDB compactions.</li></ol><p>Estimate snapshot overhead:
$$ Overhead = \frac{StateSize}{Interval} $$ (bytes/sec). Use this to budget I/O bandwidth; ensure it remains a small fraction (&lt;10%) of disk or network capacity.</p><hr><h2 id="12-putting-it-together-mini-scenario">12. Putting It Together: Mini Scenario</h2><p>Use case: Real-time fraud scoring. Requirements: &lt;500 ms p95 latency, exactly-once updates to a feature store + notifications topic.</p><p>Architecture:</p><ol><li>Kafka topics ingest transactions.</li><li>Flink job performs keyed aggregations (rolling risk scores) stored in RocksDB state.</li><li>Every 30s checkpoint with incremental snapshotting; transactional sink writes scores + commits consumer offsets.</li><li>Notification sink uses idempotent put with (user_id, window_end) key.</li></ol><p>Failure drill: kill a TaskManager mid-window; on restart, state restored, replay re-applies late events; dedupe prevents double notifications. Latency budget preserved because checkpoint duration &lt;1s and incremental diffs small vs. base state.</p><p>Outcome: Verified by chaos tests (24h run) zero duplicate notifications, stable resource usage.</p><hr><h2 id="13-checklist">13. Checklist</h2><ol><li>Do sources support replay starting from a precise offset/sequence? (Needed.)</li><li>Are all sink writes idempotent <em>or</em> wrapped in an atomic commit with source offsets?</li><li>Is operator logic deterministic given the same input order & watermark progression?</li><li>Are late event policies consistent under replay (same allowed lateness)?</li><li>Are state + offsets part of the same durability boundary (checkpoint / snapshot)?</li><li>Do you have automated failure injection tests asserting no duplicate side-effects?</li><li>Are metrics & alerts in place for aborted transactions rising above baseline?</li></ol><hr><h2 id="14-further-reading-titles">14. Further Reading (Titles)</h2><ul><li>&ldquo;Set Processing Semantics in Stream Processing&rdquo; (concept overviews)</li><li>&ldquo;Exactly-Once Semantics in Apache Flink&rdquo; (whitepaper style articles)</li><li>&ldquo;Idempotent and Transactional Producers in Apache Kafka&rdquo; (mechanism descriptions)</li><li>&ldquo;Incremental Checkpointing in State Backends&rdquo; (performance impact)</li><li>&ldquo;Watermarks and Event Time Semantics&rdquo; (window correctness)</li><li>Vendor & project blogs on transactional sinks and state backends</li></ul><hr><h2 id="15-summary">15. Summary</h2><p>Exactly-once semantics emerge from <em>coordinated components</em>: deterministic replay, atomic publication with offset progression, idempotent or transactional sinks, and bounded state snapshots. Marketing phrasing aside, it’s an engineering contract: tolerate replays internally while exposing a clean, single-effect external view. Evaluate the cost (I/O, latency, complexity) versus business impact of duplicates; sometimes <em>effectively-once</em> (idempotent sinks, at-least-once transport) is sufficient. Where correctness demands strict guarantees (finance, compliance), invest in full transactional + checkpointed pipelines and continuously test their failure modes.</p></div><footer class="ce1a612 c6dfb1e c3ecea6"><div class="c364589">Categories:
<a href=/categories/distributed%20systems/>distributed systems</a>, <a href=/categories/stream%20processing/>stream processing</a></div><div>Tags:
<a href=/tags/streaming/>#streaming</a>, <a href=/tags/kafka/>#kafka</a>, <a href=/tags/flink/>#flink</a>, <a href=/tags/semantics/>#semantics</a></div></footer></article></main><footer class="ccdf0e8" role=contentinfo aria-label=Footer><div class="cfdda01 c133889 c5df473 c0eecc8 c69618a c6942b3 c03620d c2a9f27 c7c11d8 c82c52d c14527b"><div class="c6dfb1e c3ecea6 c39ef11 c88ae6f">&copy; 2026 Leonardo Benicio. All rights
reserved.</div><div class="c6942b3 c7c11d8 cd1fd22"><a href=https://github.com/lbenicio target=_blank rel="noopener noreferrer" aria-label=GitHub class="c1d6c20 c7c11d8 c1d0018 cd1fd22 cb5c327 c10dda9 c6dfb1e cbbda39 cfc01c7 c01f421 c286dd7 c2bd687 cfdce1d cfef18f c000b66 cf55a7b c514027"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8.0 00-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35.0-3.5.0.0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35.0 3.5A5.403 5.403.0 004 9c0 3.5 3 5.5 6 5.5-.39.5-.67 1.08-.82 1.7s-.2 1.27-.18 1.9V22"/></svg>
<span class="cba5854">GitHub</span>
</a><a href=https://www.linkedin.com/in/leonardo-benicio target=_blank rel="noopener noreferrer" aria-label=LinkedIn class="c1d6c20 c7c11d8 c1d0018 cd1fd22 cb5c327 c10dda9 c6dfb1e cbbda39 cfc01c7 c01f421 c286dd7 c2bd687 cfdce1d cfef18f c000b66 cf55a7b c514027"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452H17.21V14.86c0-1.333-.027-3.046-1.858-3.046-1.86.0-2.145 1.45-2.145 2.948v5.69H9.069V9h3.112v1.561h.044c.434-.82 1.494-1.686 3.074-1.686 3.29.0 3.897 2.165 3.897 4.983v6.594zM5.337 7.433a1.805 1.805.0 11-.002-3.61 1.805 1.805.0 01.002 3.61zM6.763 20.452H3.911V9h2.852v11.452z"/></svg>
<span class="cba5854">LinkedIn</span>
</a><a href=https://twitter.com/lbenicio_ target=_blank rel="noopener noreferrer" aria-label=Twitter class="c1d6c20 c7c11d8 c1d0018 cd1fd22 cb5c327 c10dda9 c6dfb1e cbbda39 cfc01c7 c01f421 c286dd7 c2bd687 cfdce1d cfef18f c000b66 cf55a7b c514027"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.633 7.997c.013.177.013.354.013.53.0 5.386-4.099 11.599-11.6 11.599-2.31.0-4.457-.676-6.265-1.842.324.038.636.05.972.05 1.91.0 3.67-.65 5.07-1.755a4.099 4.099.0 01-3.827-2.84c.25.039.5.064.763.064.363.0.726-.051 1.065-.139A4.091 4.091.0 012.542 9.649v-.051c.538.3 1.162.482 1.824.507A4.082 4.082.0 012.54 6.7c0-.751.2-1.435.551-2.034a11.63 11.63.0 008.44 4.281 4.615 4.615.0 01-.101-.938 4.091 4.091.0 017.078-2.799 8.1 8.1.0 002.595-.988 4.112 4.112.0 01-1.8 2.261 8.2 8.2.0 002.357-.638A8.824 8.824.0 0119.613 7.96z"/></svg>
<span class="cba5854">Twitter</span></a></div></div></footer></body></html>