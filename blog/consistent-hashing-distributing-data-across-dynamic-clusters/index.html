<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><title>Consistent Hashing: Distributing Data Across Dynamic Clusters · Leonardo Benicio</title><meta name=description content="A deep dive into consistent hashing, the elegant algorithm that enables scalable distributed systems. Learn how it works, why it matters for databases and caches, and explore modern variations like jump consistent hashing and rendezvous hashing."><link rel=alternate type=application/rss+xml title=RSS href=https://lbenicio.dev/index.xml><link rel=canonical href=https://blog.lbenicio.dev/blog/consistent-hashing-distributing-data-across-dynamic-clusters/><link rel=preload href=/static/fonts/OpenSans-Regular.ttf as=font type=font/ttf crossorigin><link rel="stylesheet" href="/assets/css/fonts.min.40e2054b739ac45a0f9c940f4b44ec00c3b372356ebf61440a413c0337c5512e.css" crossorigin="anonymous" integrity="sha256-QOIFS3OaxFoPnJQPS0TsAMOzcjVuv2FECkE8AzfFUS4="><link rel="shortcut icon" href=/static/assets/favicon/favicon.ico><link rel=icon type=image/x-icon href=/static/assets/favicon/favicon.ico><link rel=icon href=/static/assets/favicon/favicon.svg type=image/svg+xml><link rel=icon href=/static/assets/favicon/favicon-32x32.png sizes=32x32 type=image/png><link rel=icon href=/static/assets/favicon/favicon-16x16.png sizes=16x16 type=image/png><link rel=apple-touch-icon href=/static/assets/favicon/apple-touch-icon.png><link rel=manifest href=/static/assets/favicon/site.webmanifest><link rel=mask-icon href=/static/assets/favicon/safari-pinned-tab.svg color=#209cee><meta name=msapplication-TileColor content="#209cee"><meta name=msapplication-config content="/static/assets/favicon/browserconfig.xml"><meta name=theme-color content="#d2e9f8"><meta property="og:title" content="Consistent Hashing: Distributing Data Across Dynamic Clusters · Leonardo Benicio"><meta property="og:description" content="A deep dive into consistent hashing, the elegant algorithm that enables scalable distributed systems. Learn how it works, why it matters for databases and caches, and explore modern variations like jump consistent hashing and rendezvous hashing."><meta property="og:url" content="https://blog.lbenicio.dev/blog/consistent-hashing-distributing-data-across-dynamic-clusters/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.lbenicio.dev/static/assets/images/blog/consistent-hashing-distributing-data-dynamic-clusters.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Consistent Hashing: Distributing Data Across Dynamic Clusters · Leonardo Benicio"><meta name=twitter:description content="A deep dive into consistent hashing, the elegant algorithm that enables scalable distributed systems. Learn how it works, why it matters for databases and caches, and explore modern variations like jump consistent hashing and rendezvous hashing."><meta name=twitter:site content="@lbenicio_"><script type=application/ld+json>{"@context":"https://schema.org","@type":"WebSite","name":"About Leonardo Benicio","url":"https://blog.lbenicio.dev"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Person","name":"Leonardo Benicio","sameAs":["https://github.com/lbenicio","https://www.linkedin.com/in/leonardo-benicio","https://twitter.com/lbenicio_"],"url":"https://blog.lbenicio.dev"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://blog.lbenicio.dev/","name":"Home","position":1},{"@type":"ListItem","item":"https://blog.lbenicio.dev/","name":"Blog","position":2},{"@type":"ListItem","item":"https://blog.lbenicio.dev/blog/consistent-hashing-distributing-data-across-dynamic-clusters/","name":"Consistent Hashing Distributing Data Across Dynamic Clusters","position":3}]}</script><link rel="stylesheet" href="/assets/css/main.min.1e8a566ac8bc3f0664d0db4ec8a015b07421c33fa11d336a6b914522a9cabf30.css" crossorigin="anonymous" integrity="sha256-6lhUOpwCHMSMROmggsVSp3AHKud6gBrIFGTzl3GV4BY="></head><body class="c6942b3 c03620d cf3bd2e"><script>(function(){try{document.addEventListener("gesturestart",function(e){e.preventDefault()}),document.addEventListener("touchstart",function(e){e.touches&&e.touches.length>1&&e.preventDefault()},{passive:!1});var e=0;document.addEventListener("touchend",function(t){var n=Date.now();n-e<=300&&t.preventDefault(),e=n},{passive:!1})}catch{}})()</script><a href=#content class="cba5854 c21e770 caffa6e cc5f604 cf2c31d cdd44dd c10dda9 c43876e c787e9b cddc2d2 cf55a7b c6dfb1e c9391e2">Skip to content</a>
<script>(function(){try{const e=localStorage.getItem("theme");e==="dark"&&document.documentElement.classList.add("dark");const t=document.querySelector('button[aria-label="Toggle theme"]');t&&t.setAttribute("aria-pressed",String(e==="dark"))}catch{}})();function toggleTheme(e){const s=document.documentElement,t=s.classList.toggle("dark");try{localStorage.setItem("theme",t?"dark":"light")}catch{}try{var n=e&&e.nodeType===1?e:document.querySelector('button[aria-label="Toggle theme"]');n&&n.setAttribute("aria-pressed",String(!!t))}catch{}}(function(){function e(){try{return document.documentElement.classList.contains("dark")?"dark":"light"}catch{return"light"}}function n(t){const n=document.getElementById("i98aca2"),s=document.getElementById("iad2af0"),o=document.getElementById("i975fb5");if(!n||!s||!o)return;try{n.style.transform="translateX(0)",n.style.transition||(n.style.transition="transform 200ms ease-out")}catch{}try{s.hidden=!1,s.style.display="block"}catch{}o.setAttribute("aria-expanded","true"),n.setAttribute("aria-hidden","false");try{document.body.classList.add("c150bbe")}catch{}const i=document.getElementById("i190984");i&&i.focus();try{window.umami&&typeof window.umami.track=="function"&&window.umami.track("mobile_menu_open",{page:location.pathname,theme:e(),source:t||"programmatic"})}catch{}}function t(t){const n=document.getElementById("i98aca2"),s=document.getElementById("iad2af0"),o=document.getElementById("i975fb5");if(!n||!s||!o)return;try{n.style.transform="translateX(100%)",n.style.transition||(n.style.transition="transform 200ms ease-out")}catch{}try{s.hidden=!0,s.style.display="none"}catch{}o.setAttribute("aria-expanded","false"),n.setAttribute("aria-hidden","true");try{document.body.classList.remove("c150bbe")}catch{}o.focus();try{window.umami&&typeof window.umami.track=="function"&&window.umami.track("mobile_menu_close",{page:location.pathname,theme:e(),source:t||"programmatic"})}catch{}}function s(e){e.key==="Escape"&&t("escape")}window.__openMobileMenu=n,window.__closeMobileMenu=t;try{window.addEventListener("keydown",s,!0)}catch{}})()</script><header class="cd019ba c98dfae cdd44dd cfdda01 c9ee25d ce2dc7a cd72dd7 cc0dc37" role=banner><div class="cfdda01 c6942b3 ccf47f4 c7c11d8"><a href=/ class="c87e2b0 c6942b3 c7c11d8 c1838fa cb594e4" aria-label=Home><img src=/static/assets/favicon/favicon.svg alt=Logo width=32 height=32 class="c3de71a c4d5191">
<span class="cf8f011 c4d1253 cbd72bc cd7e69e">Leonardo Benicio</span></a><div class="c6942b3 c85cbd4 c7c11d8 ca798da c1838fa c7a0580"><nav class="cc1689c cd9b445 c75065d c04bab1" aria-label=Main><a href=/ class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Home</a>
<a href=https://lbenicio.dev/about target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">About</a>
<a href=https://lbenicio.dev/timeline target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Timeline</a>
<a href=https://lbenicio.dev/reading target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Reading</a>
<a href=https://publications.lbenicio.dev target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Publications</a>
<a href=https://lbenicio.dev/contact target=_blank rel="noopener noreferrer" class="c4d1253 c9e4539 cbbda39 c01f421 c19ee42 c3ecea6">Contact</a></nav><button id="i1d73d4" type=button class="c1d6c20 c81ac7c c6a899b c7c11d8 c1d0018 c10dda9 c8e184d c514027 c88daee c7a66a6 c097fa1 cfc01c7 c286dd7 c2bd687 cfdce1d cfef18f" onclick=toggleTheme(this) aria-label="Toggle theme" aria-pressed=false title="Toggle theme">
<svg class="cb26e41 c50ceea cb69a5c c4f45c8 c8c2c40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="cb26e41 c8fca2b cb69a5c c4f45c8 cc1689c c9c27ff" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="4"/><path d="M12 2v4"/><path d="M12 18v4"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.93 4.93l2.83 2.83"/><path d="M16.24 16.24l2.83 2.83"/><path d="M6.34 17.66l2.83-2.83"/><path d="M14.83 9.17l2.83-2.83"/></svg>
<span class="cba5854">Toggle theme</span></button><div class="c658bcf c097fa1"><button id="i975fb5" type=button class="c1d6c20 c81ac7c c6a899b c7c11d8 c1d0018 c10dda9 c8e184d c514027 c88daee c7a66a6 cfc01c7 c286dd7 c2bd687 cfdce1d cfef18f" aria-label="Open menu" aria-controls="i98aca2" aria-expanded=false onclick='window.__openMobileMenu("button")' data-d38f920=mobile_menu_open_click>
<svg class="c20e4eb cb58471" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
<span class="cba5854">Open menu</span></button></div></div></div></header><div id="iad2af0" class="caffa6e ce4b5f4 c14639a" style=background-color:hsl(var(--background)) hidden onclick='window.__closeMobileMenu("overlay")' data-d38f920=mobile_menu_overlay_click></div><aside id="i98aca2" class="caffa6e c9efbc5 c437fa9 c49e97e c6c6936 c7cacca c7b34a4 c787e9b c88daee cad071a c6942b3 c03620d" role=dialog aria-modal=true aria-hidden=true aria-label="Mobile navigation" style="transform:translateX(100%);transition:transform 200ms ease-out;will-change:transform"><div class="c6942b3 c7c11d8 c82c52d c5df473 ccf47f4 c9ee25d"><a href=/ class="c6942b3 c7c11d8 c1838fa" aria-label=Home><img src=/static/assets/favicon/favicon.svg alt=Logo width=24 height=24 class="c20e4eb cb58471">
<span class="c62aaf0 c7c1b66 cbd72bc">Leonardo Benicio</span>
</a><button id="i190984" type=button class="c1d6c20 c81ac7c c6a899b c7c11d8 c1d0018 c10dda9 c514027 c286dd7 c2bd687 cfdce1d" aria-label="Close menu" onclick='window.__closeMobileMenu("button")' data-d38f920=mobile_menu_close_click>
<svg class="c16e528 c61f467" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
<span class="cba5854">Close</span></button></div><nav class="c85cbd4 ca0eaa4 c5df473 c6689b9"><ul class="cd69733"><li><a href=/ class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Home</a></li><li><a href=https://lbenicio.dev/about target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>About</a></li><li><a href=https://lbenicio.dev/timeline target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Timeline</a></li><li><a href=https://lbenicio.dev/reading target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Reading</a></li><li><a href=https://publications.lbenicio.dev target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Publications</a></li><li><a href=https://lbenicio.dev/contact target=_blank rel="noopener noreferrer" class="c3b5299 c10dda9 cddc2d2 cf55a7b c7c1b66 cbbda39 c3ecea6 c19ee42 c514027" onclick=window.__closeMobileMenu()>Contact</a></li></ul></nav><div class="c60a4cc ccdf0e8 c277478 c13044e"><p>&copy; 2026 Leonardo Benicio</p></div></aside><div class="caffa6e c437fa9 ce9aced c97bba6 c15da2a c975cba" role=complementary aria-label="GitHub repository"><div class="c9d056d c252f85 ca22532 ca88a1a c876315"><div class="c6942b3 c7c11d8 c1d0018 cd1fd22 c6066e4 c43876e ce3d5b6 caa20d2 c3ecea6 c0cd2e2 cddc2d2 c3ed5c9 cd4074c c876315"><a href=https://github.com/lbenicio/aboutme target=_blank rel="noopener noreferrer" class="c6942b3 c7c11d8 cd1fd22 c71bae8 cfac1ac c19ee42 c25dc7c cb40739 cbbda39 cf55a7b" aria-label="View source on GitHub"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="cb26e41 c41bcd4 cf17690 cfa4e34 c78d562" aria-hidden="true"><path d="M15 22v-4a4.8 4.8.0 00-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35.0-3.5.0.0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35.0 3.5A5.403 5.403.0 004 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
<span class="cb5c327 cd7e69e">Fork me</span></a></div></div></div><main id="i7eccc0" class="cfdda01 c5df473 c0eecc8 c85cbd4" role=main aria-label=Content><nav class="cb545ce c8d8ae4 c277478" aria-label=Breadcrumb><ol class="c6942b3 c3adaf2 c7c11d8 cd365ee c3ecea6"><li><a href=/ class="c19ee42 c71bae8 cfac1ac">Home</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><a href=/ class="c19ee42 c71bae8 cfac1ac">Blog</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><span class="c88daee">Consistent Hashing Distributing Data Across Dynamic Clusters</span></li></ol></nav><article class="c461ba0 c1c203f cfb6084 c995404 c6ca165"><nav class="cb545ce c8d8ae4 c277478" aria-label=Breadcrumb><ol class="c6942b3 c3adaf2 c7c11d8 cd365ee c3ecea6"><li><a href=/ class="c19ee42 c71bae8 cfac1ac">Home</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><a href=/ class="c19ee42 c71bae8 cfac1ac">Blog</a></li><li class="c6942b3 c7c11d8 cd365ee"><span class="cb82ddd">/</span><span class="c88daee">Consistent Hashing Distributing Data Across Dynamic Clusters</span></li></ol></nav><header class="c8aedc7"><h1 class="cf304bc c6fb0fe cf8f011 cc484e1">Consistent Hashing: Distributing Data Across Dynamic Clusters</h1><div class="c277478 c3ecea6 c8fb24a">2020-03-28
· Leonardo Benicio</div><div class="c1a1a3f c8124f2"><img src=/static/assets/images/blog/consistent-hashing-distributing-data-dynamic-clusters.png alt class="cfdda01 c524300 c677556"></div><p class="lead c3ecea6">A deep dive into consistent hashing, the elegant algorithm that enables scalable distributed systems. Learn how it works, why it matters for databases and caches, and explore modern variations like jump consistent hashing and rendezvous hashing.</p></header><div class="content"><p>When you add a server to your distributed cache, what happens to all the cached data? With naive hashing, almost everything moves—a catastrophic reshuffling that defeats the purpose of caching. Consistent hashing solves this elegantly: only K/N keys need to move, where K is total keys and N is the number of servers. This simple idea underpins some of the most scalable systems ever built. Let&rsquo;s explore how it works and why it matters.</p><h2 id="1-the-problem-with-simple-hashing">1. The Problem with Simple Hashing</h2><p>Consider a distributed cache with N servers. The naive approach:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server</span>(key, num_servers):
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> hash(key) <span style=color:#ff7b72;font-weight:700>%</span> num_servers
</span></span></code></pre></div><p>This works beautifully—until you add or remove a server.</p><h3 id="11-the-reshuffling-disaster">1.1 The Reshuffling Disaster</h3><p>With 4 servers, keys hash to servers 0-3:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>key    hash(key)   hash % 4   hash % 5 (after adding server)
</span></span><span style=display:flex><span>────────────────────────────────────────────────────────────
</span></span><span style=display:flex><span>&#34;a&#34;    12345       1          0  ← moved!
</span></span><span style=display:flex><span>&#34;b&#34;    67890       2          0  ← moved!
</span></span><span style=display:flex><span>&#34;c&#34;    11111       3          1  ← moved!
</span></span><span style=display:flex><span>&#34;d&#34;    22222       2          2  ← stayed
</span></span><span style=display:flex><span>&#34;e&#34;    33333       1          3  ← moved!
</span></span></code></pre></div><p>Adding one server moved 4 out of 5 keys! In general, adding a server moves approximately <code>(N-1)/N</code> of all keys—80% with 5 servers, 99% with 100 servers.</p><p>For a cache, this means:</p><ul><li>Almost all cache entries become invalid</li><li>The database gets hammered with requests</li><li>Performance crashes exactly when you&rsquo;re trying to scale up</li></ul><h3 id="12-the-goal">1.2 The Goal</h3><p>We want a hashing scheme where:</p><ul><li>Adding a server moves only <code>~K/N</code> keys (those that should go to the new server)</li><li>Removing a server moves only <code>~K/N</code> keys (those from the removed server)</li><li>Load is distributed evenly across servers</li></ul><p>Consistent hashing achieves all three.</p><h2 id="2-the-consistent-hashing-ring">2. The Consistent Hashing Ring</h2><p>The key insight: hash both keys and servers onto the same circular space.</p><h3 id="21-the-ring-structure">2.1 The Ring Structure</h3><p>Imagine a circle (ring) with positions 0 to 2³²-1 (using a 32-bit hash):</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>                        0
</span></span><span style=display:flex><span>                        │
</span></span><span style=display:flex><span>                   ┌────┴────┐
</span></span><span style=display:flex><span>                   │         │
</span></span><span style=display:flex><span>              ┌────┘         └────┐
</span></span><span style=display:flex><span>              │                   │
</span></span><span style=display:flex><span>        2^32-1                    2^31
</span></span><span style=display:flex><span>              │                   │
</span></span><span style=display:flex><span>              └────┐         ┌────┘
</span></span><span style=display:flex><span>                   │         │
</span></span><span style=display:flex><span>                   └────┬────┘
</span></span><span style=display:flex><span>                        │
</span></span><span style=display:flex><span>                      2^32-1/2
</span></span></code></pre></div><p>Both servers and keys are hashed to positions on this ring:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hash_to_ring</span>(item):
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> hash(item) <span style=color:#ff7b72;font-weight:700>%</span> (<span style=color:#a5d6ff>2</span><span style=color:#ff7b72;font-weight:700>**</span><span style=color:#a5d6ff>32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Servers</span>
</span></span><span style=display:flex><span>server_a_pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(<span style=color:#a5d6ff>&#34;server-a.example.com&#34;</span>)  <span style=color:#8b949e;font-style:italic># e.g., 1000000</span>
</span></span><span style=display:flex><span>server_b_pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(<span style=color:#a5d6ff>&#34;server-b.example.com&#34;</span>)  <span style=color:#8b949e;font-style:italic># e.g., 2500000</span>
</span></span><span style=display:flex><span>server_c_pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(<span style=color:#a5d6ff>&#34;server-c.example.com&#34;</span>)  <span style=color:#8b949e;font-style:italic># e.g., 3800000</span>
</span></span></code></pre></div><h3 id="22-key-assignment">2.2 Key Assignment</h3><p>A key is assigned to the first server encountered when walking clockwise from the key&rsquo;s position:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Ring positions (simplified 0-100 scale):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     0
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Server A (10)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Key &#34;foo&#34; (25) ──────► Goes to Server B
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Server B (30)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Key &#34;bar&#34; (55) ──────► Goes to Server C
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Server C (60)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Key &#34;baz&#34; (85) ──────► Goes to Server A (wraps around)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>   100/0
</span></span></code></pre></div><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server</span>(key, sorted_servers):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Find the first server clockwise from the key&#39;s position.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    key_pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> server_pos, server_name <span style=color:#ff7b72;font-weight:700>in</span> sorted_servers:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> server_pos <span style=color:#ff7b72;font-weight:700>&gt;=</span> key_pos:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> server_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Wrap around to first server</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> sorted_servers[<span style=color:#a5d6ff>0</span>][<span style=color:#a5d6ff>1</span>]
</span></span></code></pre></div><h3 id="23-adding-a-server">2.3 Adding a Server</h3><p>When server D joins at position 45:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Before:
</span></span><span style=display:flex><span>Keys 31-60 → Server C
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>After:
</span></span><span style=display:flex><span>Keys 31-45 → Server D (new)
</span></span><span style=display:flex><span>Keys 46-60 → Server C (unchanged)
</span></span></code></pre></div><p>Only keys in the range [31, 45] move—approximately 1/N of the keyspace. All other keys remain on their current servers.</p><h3 id="24-removing-a-server">2.4 Removing a Server</h3><p>When server B leaves:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Before:
</span></span><span style=display:flex><span>Keys 11-30 → Server B
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>After:
</span></span><span style=display:flex><span>Keys 11-30 → Server C (next clockwise)
</span></span></code></pre></div><p>Again, only ~1/N of keys move—those that were on the removed server.</p><h2 id="3-virtual-nodes">3. Virtual Nodes</h2><p>The basic ring has a problem: servers may not be evenly distributed, causing load imbalance.</p><h3 id="31-the-imbalance-problem">3.1 The Imbalance Problem</h3><p>With 3 servers randomly placed:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>     0
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Server A (5)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │   ← A handles 5% of ring
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Server B (10)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │   ← B handles 60% of ring!
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     ├── Server C (70)
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>     │   ← C handles 35% of ring
</span></span><span style=display:flex><span>     │
</span></span><span style=display:flex><span>   100
</span></span></code></pre></div><p>Server B handles 60% of traffic while A handles only 5%. This defeats the purpose of distribution!</p><h3 id="32-virtual-nodes-solution">3.2 Virtual Nodes Solution</h3><p>Instead of one position per server, use many virtual positions:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>add_server</span>(ring, server_name, num_virtual_nodes<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>150</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(num_virtual_nodes):
</span></span><span style=display:flex><span>        virtual_id <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>server_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>#vnode</span><span style=color:#a5d6ff>{</span>i<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>        position <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(virtual_id)
</span></span><span style=display:flex><span>        ring[position] <span style=color:#ff7b72;font-weight:700>=</span> server_name
</span></span></code></pre></div><p>With 150 virtual nodes per server, each server gets ~150 positions scattered around the ring:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>     0
</span></span><span style=display:flex><span>     ├── A#vnode42 (2)
</span></span><span style=display:flex><span>     ├── C#vnode17 (5)
</span></span><span style=display:flex><span>     ├── B#vnode89 (8)
</span></span><span style=display:flex><span>     ├── A#vnode3 (12)
</span></span><span style=display:flex><span>     ├── B#vnode45 (15)
</span></span><span style=display:flex><span>     ├── C#vnode91 (18)
</span></span><span style=display:flex><span>     │   ...
</span></span><span style=display:flex><span>   100
</span></span></code></pre></div><p>Now each server handles approximately 1/N of the ring, regardless of the random hash positions.</p><h3 id="33-load-distribution-analysis">3.3 Load Distribution Analysis</h3><p>With V virtual nodes per server:</p><ul><li>Standard deviation of load: <code>~1/√(V*N)</code></li><li>With 150 virtual nodes and 10 servers: <code>~2.6%</code> standard deviation</li><li>With 1000 virtual nodes and 10 servers: <code>~1%</code> standard deviation</li></ul><p>The trade-off: more virtual nodes means better balance but more memory and lookup time.</p><h3 id="34-heterogeneous-servers">3.4 Heterogeneous Servers</h3><p>Virtual nodes enable weighted distribution:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Server with 2x capacity gets 2x virtual nodes</span>
</span></span><span style=display:flex><span>add_server(ring, <span style=color:#a5d6ff>&#34;big-server&#34;</span>, num_virtual_nodes<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>300</span>)
</span></span><span style=display:flex><span>add_server(ring, <span style=color:#a5d6ff>&#34;small-server&#34;</span>, num_virtual_nodes<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>150</span>)
</span></span></code></pre></div><p>This naturally distributes load proportional to server capacity.</p><h2 id="4-implementation-details">4. Implementation Details</h2><h3 id="41-efficient-lookup">4.1 Efficient Lookup</h3><p>A naive linear search is O(N×V). Use a sorted data structure:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>bisect</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ConsistentHash</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, num_virtual_nodes<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>150</span>):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>num_virtual_nodes <span style=color:#ff7b72;font-weight:700>=</span> num_virtual_nodes
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> []  <span style=color:#8b949e;font-style:italic># Sorted list of (position, server)</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>servers <span style=color:#ff7b72;font-weight:700>=</span> {}  <span style=color:#8b949e;font-style:italic># server -&gt; list of positions</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>add_server</span>(self, server):
</span></span><span style=display:flex><span>        positions <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(self<span style=color:#ff7b72;font-weight:700>.</span>num_virtual_nodes):
</span></span><span style=display:flex><span>            pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>#vnode</span><span style=color:#a5d6ff>{</span>i<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            positions<span style=color:#ff7b72;font-weight:700>.</span>append(pos)
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># Insert into sorted ring</span>
</span></span><span style=display:flex><span>            bisect<span style=color:#ff7b72;font-weight:700>.</span>insort(self<span style=color:#ff7b72;font-weight:700>.</span>ring, (pos, server))
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>servers[server] <span style=color:#ff7b72;font-weight:700>=</span> positions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>remove_server</span>(self, server):
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> pos <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>servers[server]:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># Remove from ring (O(n) but infrequent)</span>
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>remove((pos, server))
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>del</span> self<span style=color:#ff7b72;font-weight:700>.</span>servers[server]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server</span>(self, key):
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(key)
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Binary search for first position &gt;= key</span>
</span></span><span style=display:flex><span>        idx <span style=color:#ff7b72;font-weight:700>=</span> bisect<span style=color:#ff7b72;font-weight:700>.</span>bisect_left(self<span style=color:#ff7b72;font-weight:700>.</span>ring, (pos,))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> idx <span style=color:#ff7b72;font-weight:700>==</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>ring):
</span></span><span style=display:flex><span>            idx <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>  <span style=color:#8b949e;font-style:italic># Wrap around</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring[idx][<span style=color:#a5d6ff>1</span>]
</span></span></code></pre></div><p>Lookup is O(log(N×V)), typically &lt;10 comparisons even with millions of virtual nodes.</p><h3 id="42-hash-function-choice">4.2 Hash Function Choice</h3><p>The hash function must:</p><ul><li>Distribute uniformly (avoid clustering)</li><li>Be deterministic (same input → same output)</li><li>Be fast (called frequently)</li></ul><p>Good choices:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>import</span> <span style=color:#ff7b72>hashlib</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hash_to_ring_md5</span>(item):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;MD5 - good distribution, cryptographic (slower).&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> int(hashlib<span style=color:#ff7b72;font-weight:700>.</span>md5(item<span style=color:#ff7b72;font-weight:700>.</span>encode())<span style=color:#ff7b72;font-weight:700>.</span>hexdigest(), <span style=color:#a5d6ff>16</span>) <span style=color:#ff7b72;font-weight:700>%</span> (<span style=color:#a5d6ff>2</span><span style=color:#ff7b72;font-weight:700>**</span><span style=color:#a5d6ff>32</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hash_to_ring_xxhash</span>(item):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;xxHash - excellent distribution, very fast.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>xxhash</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> xxhash<span style=color:#ff7b72;font-weight:700>.</span>xxh32(item<span style=color:#ff7b72;font-weight:700>.</span>encode())<span style=color:#ff7b72;font-weight:700>.</span>intdigest()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>hash_to_ring_murmur</span>(item):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;MurmurHash3 - good distribution, fast.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>import</span> <span style=color:#ff7b72>mmh3</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> mmh3<span style=color:#ff7b72;font-weight:700>.</span>hash(item, signed<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>)
</span></span></code></pre></div><p>Avoid:</p><ul><li>Python&rsquo;s built-in <code>hash()</code> (not consistent across runs)</li><li>CRC32 (poor distribution for some inputs)</li><li>Simple polynomial hashes (clustering prone)</li></ul><h3 id="43-handling-replication">4.3 Handling Replication</h3><p>For fault tolerance, replicate data across multiple servers:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_servers</span>(self, key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Get N servers for a key, walking clockwise.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> <span style=color:#ff7b72;font-weight:700>not</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(key)
</span></span><span style=display:flex><span>    idx <span style=color:#ff7b72;font-weight:700>=</span> bisect<span style=color:#ff7b72;font-weight:700>.</span>bisect_left(self<span style=color:#ff7b72;font-weight:700>.</span>ring, (pos,))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    servers <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>    seen <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>while</span> len(servers) <span style=color:#ff7b72;font-weight:700>&lt;</span> num_replicas <span style=color:#ff7b72;font-weight:700>and</span> len(seen) <span style=color:#ff7b72;font-weight:700>&lt;</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>servers):
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> idx <span style=color:#ff7b72;font-weight:700>&gt;=</span> len(self<span style=color:#ff7b72;font-weight:700>.</span>ring):
</span></span><span style=display:flex><span>            idx <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring[idx][<span style=color:#a5d6ff>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> server <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> seen:
</span></span><span style=display:flex><span>            servers<span style=color:#ff7b72;font-weight:700>.</span>append(server)
</span></span><span style=display:flex><span>            seen<span style=color:#ff7b72;font-weight:700>.</span>add(server)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        idx <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> servers
</span></span></code></pre></div><p>This ensures replicas are on different physical servers, not just different virtual nodes of the same server.</p><h2 id="5-real-world-applications">5. Real-World Applications</h2><h3 id="51-amazon-dynamodb-dynamo-paper">5.1 Amazon DynamoDB (Dynamo Paper)</h3><p>Dynamo pioneered consistent hashing for databases:</p><ul><li>Each node responsible for a range of the ring</li><li>Replication across N consecutive nodes</li><li>Vector clocks for conflict resolution</li><li>Sloppy quorum for availability</li></ul><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Ring with replication factor 3:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Key K hashes to position P
</span></span><span style=display:flex><span>├── Primary: First node clockwise from P
</span></span><span style=display:flex><span>├── Replica 1: Second node clockwise
</span></span><span style=display:flex><span>└── Replica 2: Third node clockwise
</span></span></code></pre></div><h3 id="52-apache-cassandra">5.2 Apache Cassandra</h3><p>Cassandra uses consistent hashing with virtual nodes:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-yaml" data-lang=yaml><span style=display:flex><span><span style=color:#8b949e;font-style:italic># cassandra.yaml</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#7ee787>num_tokens</span>:<span style=color:#6e7681> </span><span style=color:#a5d6ff>256</span><span style=color:#6e7681> </span><span style=color:#8b949e;font-style:italic># Virtual nodes per server</span><span style=color:#6e7681>
</span></span></span></code></pre></div><p>With 256 tokens per node and 10 nodes:</p><ul><li>2560 total positions on the ring</li><li>Load variance &lt; 5%</li><li>Adding a node moves only ~10% of data</li></ul><h3 id="53-memcached-clients">5.3 Memcached Clients</h3><p>Memcached servers are independent; consistent hashing is implemented client-side:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># libmemcached configuration</span>
</span></span><span style=display:flex><span>memcached_servers <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;cache1.example.com:11211&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;cache2.example.com:11211&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;cache3.example.com:11211&#34;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Client uses consistent hashing to pick server</span>
</span></span><span style=display:flex><span>client <span style=color:#ff7b72;font-weight:700>=</span> pylibmc<span style=color:#ff7b72;font-weight:700>.</span>Client(memcached_servers, behaviors<span style=color:#ff7b72;font-weight:700>=</span>{
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;ketama&#34;</span>: <span style=color:#79c0ff>True</span>,  <span style=color:#8b949e;font-style:italic># Consistent hashing algorithm</span>
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;ketama_weighted&#34;</span>: <span style=color:#79c0ff>True</span>,  <span style=color:#8b949e;font-style:italic># Support weighted servers</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p>This allows cache servers to be added/removed without invalidating the entire cache.</p><h3 id="54-load-balancers">5.4 Load Balancers</h3><p>Nginx uses consistent hashing for upstream selection:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-nginx" data-lang=nginx><span style=display:flex><span><span style=color:#ff7b72>upstream</span> <span style=color:#a5d6ff>backend</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>hash</span> <span style=color:#79c0ff>$request_uri</span> <span style=color:#a5d6ff>consistent</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>server</span> <span style=color:#a5d6ff>backend1.example.com</span> <span style=color:#a5d6ff>weight=5</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>server</span> <span style=color:#a5d6ff>backend2.example.com</span> <span style=color:#a5d6ff>weight=3</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>server</span> <span style=color:#a5d6ff>backend3.example.com</span> <span style=color:#a5d6ff>weight=2</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This ensures the same URL always goes to the same backend, enabling per-server caching.</p><h3 id="55-content-delivery-networks">5.5 Content Delivery Networks</h3><p>CDNs use consistent hashing to route requests to edge servers:</p><ul><li>Hash the content URL</li><li>Route to the nearest edge server handling that hash range</li><li>If the edge server fails, traffic moves to the next server on the ring</li></ul><p>This minimizes cache invalidation when edge servers fail or are added.</p><h2 id="6-alternatives-and-variations">6. Alternatives and Variations</h2><h3 id="61-rendezvous-hashing-hrw">6.1 Rendezvous Hashing (HRW)</h3><p>Rendezvous hashing (Highest Random Weight) takes a different approach:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server_hrw</span>(key, servers):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Each server gets a score; highest score wins.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>score</span>(server):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Combine key and server into a single hash</span>
</span></span><span style=display:flex><span>        combined <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> hash_to_ring(combined)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> max(servers, key<span style=color:#ff7b72;font-weight:700>=</span>score)
</span></span></code></pre></div><p><strong>Advantages:</strong></p><ul><li>No ring structure needed</li><li>O(N) lookup, but simple and cache-friendly</li><li>Perfect load balance (no virtual nodes needed)</li><li>Adding a server moves exactly 1/N keys</li></ul><p><strong>Disadvantages:</strong></p><ul><li>O(N) per lookup (vs. O(log N) for ring)</li><li>Less flexible than virtual nodes for weighting</li></ul><h3 id="62-jump-consistent-hashing">6.2 Jump Consistent Hashing</h3><p>Google&rsquo;s jump consistent hash is remarkably simple:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>jump_consistent_hash</span>(key, num_buckets):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Google&#39;s jump consistent hash - O(log n), no memory.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    b, j <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>, <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>while</span> j <span style=color:#ff7b72;font-weight:700>&lt;</span> num_buckets:
</span></span><span style=display:flex><span>        b <span style=color:#ff7b72;font-weight:700>=</span> j
</span></span><span style=display:flex><span>        key <span style=color:#ff7b72;font-weight:700>=</span> ((key <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>2862933555777941757</span>) <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>&amp;</span> <span style=color:#a5d6ff>0xFFFFFFFFFFFFFFFF</span>
</span></span><span style=display:flex><span>        j <span style=color:#ff7b72;font-weight:700>=</span> int((b <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>*</span> (<span style=color:#a5d6ff>1</span> <span style=color:#ff7b72;font-weight:700>&lt;&lt;</span> <span style=color:#a5d6ff>31</span>) <span style=color:#ff7b72;font-weight:700>/</span> ((key <span style=color:#ff7b72;font-weight:700>&gt;&gt;</span> <span style=color:#a5d6ff>33</span>) <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>))
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> b
</span></span></code></pre></div><p><strong>Amazing properties:</strong></p><ul><li>O(log N) time complexity</li><li>Zero memory (no ring to store!)</li><li>Perfect load balance</li><li>Minimal movement (exactly K/N keys move)</li></ul><p><strong>Limitations:</strong></p><ul><li>Only supports sequential bucket IDs (0 to N-1)</li><li>Can&rsquo;t remove arbitrary servers (only remove from the end)</li><li>No support for heterogeneous servers</li></ul><p><strong>Perfect for:</strong> Sharded databases where servers are numbered 0 to N-1.</p><h3 id="63-maglev-hashing">6.3 Maglev Hashing</h3><p>Google&rsquo;s Maglev load balancer uses a lookup table approach:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>build_maglev_table</span>(servers, table_size<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>65537</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Build a lookup table for O(1) server selection.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Each server gets a permutation of table positions</span>
</span></span><span style=display:flex><span>    permutations <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> server <span style=color:#ff7b72;font-weight:700>in</span> servers:
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Generate a permutation unique to this server</span>
</span></span><span style=display:flex><span>        seed1 <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:offset&#34;</span>)
</span></span><span style=display:flex><span>        seed2 <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:skip&#34;</span>)
</span></span><span style=display:flex><span>        offset <span style=color:#ff7b72;font-weight:700>=</span> seed1 <span style=color:#ff7b72;font-weight:700>%</span> table_size
</span></span><span style=display:flex><span>        skip <span style=color:#ff7b72;font-weight:700>=</span> seed2 <span style=color:#ff7b72;font-weight:700>%</span> (table_size <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>) <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        permutations[server] <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>            (offset <span style=color:#ff7b72;font-weight:700>+</span> i <span style=color:#ff7b72;font-weight:700>*</span> skip) <span style=color:#ff7b72;font-weight:700>%</span> table_size
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(table_size)
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Build table: each position assigned to first server that &#34;wants&#34; it</span>
</span></span><span style=display:flex><span>    table <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#79c0ff>None</span>] <span style=color:#ff7b72;font-weight:700>*</span> table_size
</span></span><span style=display:flex><span>    next_index <span style=color:#ff7b72;font-weight:700>=</span> {s: <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> servers}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    filled <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>while</span> filled <span style=color:#ff7b72;font-weight:700>&lt;</span> table_size:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> server <span style=color:#ff7b72;font-weight:700>in</span> servers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>while</span> <span style=color:#79c0ff>True</span>:
</span></span><span style=display:flex><span>                pos <span style=color:#ff7b72;font-weight:700>=</span> permutations[server][next_index[server]]
</span></span><span style=display:flex><span>                next_index[server] <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> table[pos] <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>                    table[pos] <span style=color:#ff7b72;font-weight:700>=</span> server
</span></span><span style=display:flex><span>                    filled <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> table
</span></span></code></pre></div><p><strong>Properties:</strong></p><ul><li>O(1) lookup (just <code>table[hash(key) % table_size]</code>)</li><li>Good load balance</li><li>Minimal disruption (similar to consistent hashing)</li><li>Deterministic (same table on all clients)</li></ul><p><strong>Used in:</strong> Google&rsquo;s network load balancers, some CDNs.</p><h3 id="64-multi-probe-consistent-hashing">6.4 Multi-Probe Consistent Hashing</h3><p>Microsoft&rsquo;s approach: probe multiple positions, pick the least-loaded:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server_multiprobe</span>(key, ring, num_probes<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>21</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Probe multiple positions, return least-loaded server.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    candidates <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(num_probes):
</span></span><span style=display:flex><span>        probe_key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:probe</span><span style=color:#a5d6ff>{</span>i<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>        pos <span style=color:#ff7b72;font-weight:700>=</span> hash_to_ring(probe_key)
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server_at(pos)
</span></span><span style=display:flex><span>        candidates<span style=color:#ff7b72;font-weight:700>.</span>append(server)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Return least-loaded among candidates</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> min(candidates, key<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#ff7b72>lambda</span> s: s<span style=color:#ff7b72;font-weight:700>.</span>current_load)
</span></span></code></pre></div><p>This combines consistent hashing with load awareness for better balance.</p><h2 id="7-handling-failures-and-recovery">7. Handling Failures and Recovery</h2><h3 id="71-detecting-failures">7.1 Detecting Failures</h3><p>Consistent hashing doesn&rsquo;t detect failures; it needs a failure detection layer:</p><ul><li><strong>Heartbeats:</strong> Servers periodically ping each other</li><li><strong>Gossip protocol:</strong> Failure information spreads exponentially</li><li><strong>Health checks:</strong> Load balancers probe backends</li></ul><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ConsistentHashWithHealth</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ConsistentHash()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>healthy_servers <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server</span>(self, key):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Walk the ring until we find a healthy server</span>
</span></span><span style=display:flex><span>        servers <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_servers(key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> server <span style=color:#ff7b72;font-weight:700>in</span> servers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> server <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>healthy_servers:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> server
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>  <span style=color:#8b949e;font-style:italic># All servers down!</span>
</span></span></code></pre></div><h3 id="72-graceful-removal">7.2 Graceful Removal</h3><p>When removing a server, move data before removal:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>remove_server_graceful</span>(ring, server_to_remove):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 1. Find all keys owned by this server</span>
</span></span><span style=display:flex><span>    keys_to_move <span style=color:#ff7b72;font-weight:700>=</span> get_keys_for_server(server_to_remove)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 2. For each key, find the next server (after removal)</span>
</span></span><span style=display:flex><span>    ring<span style=color:#ff7b72;font-weight:700>.</span>remove_server(server_to_remove)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 3. Copy data to new owners (before actual shutdown)</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> key <span style=color:#ff7b72;font-weight:700>in</span> keys_to_move:
</span></span><span style=display:flex><span>        new_server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        copy_data(key, server_to_remove, new_server)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># 4. Now safe to shut down</span>
</span></span><span style=display:flex><span>    shutdown(server_to_remove)
</span></span></code></pre></div><h3 id="73-handling-hotspots">7.3 Handling Hotspots</h3><p>Some keys are accessed much more than others. Solutions:</p><p><strong>Client-side caching:</strong> Cache hot keys locally.</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span>local_cache <span style=color:#ff7b72;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get</span>(key):
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> key <span style=color:#ff7b72;font-weight:700>in</span> local_cache:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> local_cache[key]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>    value <span style=color:#ff7b72;font-weight:700>=</span> server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> is_hot(key):
</span></span><span style=display:flex><span>        local_cache[key] <span style=color:#ff7b72;font-weight:700>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> value
</span></span></code></pre></div><p><strong>Key splitting:</strong> Distribute hot keys across multiple servers.</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_key_with_splitting</span>(base_key, is_write<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>False</span>):
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> is_hot(base_key) <span style=color:#ff7b72;font-weight:700>and</span> <span style=color:#ff7b72;font-weight:700>not</span> is_write:
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Read from random replica</span>
</span></span><span style=display:flex><span>        suffix <span style=color:#ff7b72;font-weight:700>=</span> random<span style=color:#ff7b72;font-weight:700>.</span>randint(<span style=color:#a5d6ff>0</span>, <span style=color:#a5d6ff>9</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>base_key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:split</span><span style=color:#a5d6ff>{</span>suffix<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> base_key
</span></span></code></pre></div><p><strong>Request coalescing:</strong> Batch multiple requests for the same key.</p><h2 id="8-consistent-hashing-at-scale">8. Consistent Hashing at Scale</h2><h3 id="81-multi-datacenter-deployment">8.1 Multi-Datacenter Deployment</h3><p>With multiple datacenters, consistent hashing operates at two levels:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Level 1: Datacenter selection
</span></span><span style=display:flex><span>    hash(key) → Datacenter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Level 2: Server selection within datacenter
</span></span><span style=display:flex><span>    hash(key) → Server in selected datacenter
</span></span></code></pre></div><p>For latency, prefer the local datacenter but fall back to remote:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server_multi_dc</span>(key, local_dc, all_dcs):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Try local datacenter first</span>
</span></span><span style=display:flex><span>    local_servers <span style=color:#ff7b72;font-weight:700>=</span> all_dcs[local_dc]<span style=color:#ff7b72;font-weight:700>.</span>get_servers(key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>    healthy_local <span style=color:#ff7b72;font-weight:700>=</span> [s <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> local_servers <span style=color:#ff7b72>if</span> s<span style=color:#ff7b72;font-weight:700>.</span>healthy]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> healthy_local:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> healthy_local[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Fall back to other datacenters</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> dc <span style=color:#ff7b72;font-weight:700>in</span> all_dcs:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> dc <span style=color:#ff7b72;font-weight:700>!=</span> local_dc:
</span></span><span style=display:flex><span>            servers <span style=color:#ff7b72;font-weight:700>=</span> all_dcs[dc]<span style=color:#ff7b72;font-weight:700>.</span>get_servers(key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>            healthy <span style=color:#ff7b72;font-weight:700>=</span> [s <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> servers <span style=color:#ff7b72>if</span> s<span style=color:#ff7b72;font-weight:700>.</span>healthy]
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> healthy:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>return</span> healthy[<span style=color:#a5d6ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> <span style=color:#79c0ff>None</span>
</span></span></code></pre></div><h3 id="82-handling-network-partitions">8.2 Handling Network Partitions</h3><p>During a partition, different clients may see different ring states:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-text" data-lang=text><span style=display:flex><span>Client A sees: [Server1, Server2, Server3]
</span></span><span style=display:flex><span>Client B sees: [Server1, Server2]  (Server3 appears down)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Key K: Client A routes to Server3
</span></span><span style=display:flex><span>       Client B routes to Server1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Result: Inconsistency!
</span></span></code></pre></div><p>Solutions:</p><p><strong>Sloppy quorum:</strong> Write to any N available nodes, read from any N nodes:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>write_sloppy</span>(key, value, ring, n<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>, w<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span>):
</span></span><span style=display:flex><span>    servers <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_healthy_servers(key, n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    successes <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> server <span style=color:#ff7b72;font-weight:700>in</span> servers:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>try</span>:
</span></span><span style=display:flex><span>            server<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)
</span></span><span style=display:flex><span>            successes <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> successes <span style=color:#ff7b72;font-weight:700>&gt;=</span> w  <span style=color:#8b949e;font-style:italic># Write succeeds if w servers acknowledge</span>
</span></span></code></pre></div><p><strong>Hinted handoff:</strong> When the &ldquo;right&rdquo; server is unavailable, write to another with a hint:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>write_with_hint</span>(key, value, ring):
</span></span><span style=display:flex><span>    intended_server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> intended_server<span style=color:#ff7b72;font-weight:700>.</span>is_healthy():
</span></span><span style=display:flex><span>        intended_server<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Store with hint on another server</span>
</span></span><span style=display:flex><span>        backup <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_next_healthy_server(key)
</span></span><span style=display:flex><span>        backup<span style=color:#ff7b72;font-weight:700>.</span>put_with_hint(key, value, intended_server)
</span></span></code></pre></div><p>When the intended server recovers, it receives the hinted data.</p><h3 id="83-rebalancing-strategies">8.3 Rebalancing Strategies</h3><p>When servers are added, data must be redistributed:</p><p><strong>Lazy rebalancing:</strong> Data moves on access.</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_lazy</span>(key):
</span></span><span style=display:flex><span>    new_server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>    value <span style=color:#ff7b72;font-weight:700>=</span> new_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> value <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Check old servers (before rebalancing)</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> old_server <span style=color:#ff7b72;font-weight:700>in</span> get_previous_servers(key):
</span></span><span style=display:flex><span>            value <span style=color:#ff7b72;font-weight:700>=</span> old_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> value:
</span></span><span style=display:flex><span>                new_server<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)  <span style=color:#8b949e;font-style:italic># Move on access</span>
</span></span><span style=display:flex><span>                old_server<span style=color:#ff7b72;font-weight:700>.</span>delete(key)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> value
</span></span></code></pre></div><p><strong>Background rebalancing:</strong> Gradually move data in the background.</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>rebalance_background</span>(ring, new_server):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Find all keys that should move to new_server</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> existing_server <span style=color:#ff7b72;font-weight:700>in</span> ring<span style=color:#ff7b72;font-weight:700>.</span>servers:
</span></span><span style=display:flex><span>        keys_to_move <span style=color:#ff7b72;font-weight:700>=</span> existing_server<span style=color:#ff7b72;font-weight:700>.</span>scan_keys_for_server(new_server)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> key <span style=color:#ff7b72;font-weight:700>in</span> keys_to_move:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># Throttle to avoid overwhelming the network</span>
</span></span><span style=display:flex><span>            rate_limiter<span style=color:#ff7b72;font-weight:700>.</span>wait()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            value <span style=color:#ff7b72;font-weight:700>=</span> existing_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>            new_server<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)
</span></span><span style=display:flex><span>            existing_server<span style=color:#ff7b72;font-weight:700>.</span>delete(key)
</span></span></code></pre></div><h2 id="9-common-pitfalls">9. Common Pitfalls</h2><h3 id="91-hash-collision-handling">9.1 Hash Collision Handling</h3><p>While rare, hash collisions can cause problems:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Bad: Collision causes key loss</span>
</span></span><span style=display:flex><span>ring[(position, <span style=color:#79c0ff>None</span>)] <span style=color:#ff7b72;font-weight:700>=</span> server  <span style=color:#8b949e;font-style:italic># What if position exists?</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Good: Handle collisions</span>
</span></span><span style=display:flex><span>ring[(position, key_id)] <span style=color:#ff7b72;font-weight:700>=</span> server  <span style=color:#8b949e;font-style:italic># Include unique identifier</span>
</span></span></code></pre></div><h3 id="92-ring-inconsistency">9.2 Ring Inconsistency</h3><p>Different clients must see the same ring, or routing breaks:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Bad: Local ring modification</span>
</span></span><span style=display:flex><span>ring<span style=color:#ff7b72;font-weight:700>.</span>add_server(new_server)  <span style=color:#8b949e;font-style:italic># Only this client knows!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Good: Centralized configuration</span>
</span></span><span style=display:flex><span>ring_config <span style=color:#ff7b72;font-weight:700>=</span> zookeeper<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#34;/ring/config&#34;</span>)
</span></span><span style=display:flex><span>ring <span style=color:#ff7b72;font-weight:700>=</span> ConsistentHash<span style=color:#ff7b72;font-weight:700>.</span>from_config(ring_config)
</span></span></code></pre></div><p>Use a coordination service (ZooKeeper, etcd, Consul) for ring configuration.</p><h3 id="93-hash-function-mismatch">9.3 Hash Function Mismatch</h3><p>Clients and servers must use the same hash function:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Client uses MD5</span>
</span></span><span style=display:flex><span>client_pos <span style=color:#ff7b72;font-weight:700>=</span> md5(key) <span style=color:#ff7b72;font-weight:700>%</span> <span style=color:#a5d6ff>2</span><span style=color:#ff7b72;font-weight:700>**</span><span style=color:#a5d6ff>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Server uses xxHash (WRONG!)</span>
</span></span><span style=display:flex><span>server_pos <span style=color:#ff7b72;font-weight:700>=</span> xxhash(key) <span style=color:#ff7b72;font-weight:700>%</span> <span style=color:#a5d6ff>2</span><span style=color:#ff7b72;font-weight:700>**</span><span style=color:#a5d6ff>32</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Key will route to wrong server!</span>
</span></span></code></pre></div><p>Specify the hash function explicitly in configuration.</p><h3 id="94-virtual-node-count">9.4 Virtual Node Count</h3><p>Too few virtual nodes: poor load balance.
Too many virtual nodes: memory and lookup overhead.</p><p>Rule of thumb:</p><ul><li>100-200 virtual nodes per server for good balance</li><li>More for very large clusters (1000+ servers)</li><li>Fewer for memory-constrained environments</li></ul><h3 id="95-ignoring-rackzone-awareness">9.5 Ignoring Rack/Zone Awareness</h3><p>Replicas on the same rack fail together:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Bad: Replicas might be on same rack</span>
</span></span><span style=display:flex><span>servers <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_servers(key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic># Good: Ensure replicas are in different failure domains</span>
</span></span><span style=display:flex><span>servers <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_servers_rack_aware(key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_servers_rack_aware</span>(self, key, num_replicas<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>3</span>):
</span></span><span style=display:flex><span>    servers <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>    racks_seen <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> candidate <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>walk_from(key):
</span></span><span style=display:flex><span>        rack <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>server_to_rack[candidate]
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> rack <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> racks_seen:
</span></span><span style=display:flex><span>            servers<span style=color:#ff7b72;font-weight:700>.</span>append(candidate)
</span></span><span style=display:flex><span>            racks_seen<span style=color:#ff7b72;font-weight:700>.</span>add(rack)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> len(servers) <span style=color:#ff7b72;font-weight:700>&gt;=</span> num_replicas:
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> servers
</span></span></code></pre></div><h2 id="10-performance-considerations">10. Performance Considerations</h2><h3 id="101-lookup-performance">10.1 Lookup Performance</h3><table><thead><tr><th>Operation</th><th>Ring (Binary Search)</th><th>Jump Hash</th><th>Maglev</th><th>Rendezvous</th></tr></thead><tbody><tr><td>Lookup</td><td>O(log(N×V))</td><td>O(log N)</td><td>O(1)</td><td>O(N)</td></tr><tr><td>Add Server</td><td>O(V×log(N×V))</td><td>O(1)</td><td>O(N×M)</td><td>O(1)</td></tr><tr><td>Remove Server</td><td>O(V×N×V)</td><td>N/A*</td><td>O(N×M)</td><td>O(1)</td></tr><tr><td>Memory</td><td>O(N×V)</td><td>O(1)</td><td>O(M)</td><td>O(N)</td></tr></tbody></table><p>*Jump hash only supports removing from the end.</p><h3 id="102-when-to-use-what">10.2 When to Use What</h3><p><strong>Standard consistent hashing ring:</strong></p><ul><li>General-purpose distributed systems</li><li>Need to add/remove arbitrary servers</li><li>Need weighted distribution</li></ul><p><strong>Jump consistent hashing:</strong></p><ul><li>Numbered shards (shard 0, 1, 2, &mldr;)</li><li>Add-only server growth</li><li>Memory-constrained environments</li></ul><p><strong>Maglev hashing:</strong></p><ul><li>Network load balancers</li><li>Need O(1) lookup</li><li>Can afford table rebuild on changes</li></ul><p><strong>Rendezvous hashing:</strong></p><ul><li>Simple implementation needed</li><li>Small number of servers</li><li>Stateless clients</li></ul><h3 id="103-caching-ring-state">10.3 Caching Ring State</h3><p>Ring computation can be cached:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>CachedConsistentHash</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, ring, cache_size<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>10000</span>):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ring
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>cache <span style=color:#ff7b72;font-weight:700>=</span> LRUCache(cache_size)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_server</span>(self, key):
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> key <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>cache:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>cache[key]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>cache[key] <span style=color:#ff7b72;font-weight:700>=</span> server
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>invalidate_cache</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Called when ring changes</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>cache<span style=color:#ff7b72;font-weight:700>.</span>clear()
</span></span></code></pre></div><p>For stable rings, this dramatically reduces lookup overhead.</p><h2 id="11-consistent-hashing-in-practice">11. Consistent Hashing in Practice</h2><h3 id="111-database-sharding">11.1 Database Sharding</h3><p>Consistent hashing determines which shard holds each key:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ShardedDatabase</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, shards):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ConsistentHash()
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> shard <span style=color:#ff7b72;font-weight:700>in</span> shards:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>add_server(shard)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get</span>(self, key):
</span></span><span style=display:flex><span>        shard <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> shard<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>put</span>(self, key, value):
</span></span><span style=display:flex><span>        shard <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        shard<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)
</span></span></code></pre></div><p>This enables horizontal scaling: add shards to increase capacity.</p><h3 id="112-session-affinity">11.2 Session Affinity</h3><p>Web applications often need session stickiness:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>route_request</span>(request):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Hash session ID to get consistent server</span>
</span></span><span style=display:flex><span>    session_id <span style=color:#ff7b72;font-weight:700>=</span> request<span style=color:#ff7b72;font-weight:700>.</span>cookies<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#a5d6ff>&#39;session_id&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> session_id:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(session_id)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># New session: pick random server</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> random<span style=color:#ff7b72;font-weight:700>.</span>choice(servers)
</span></span></code></pre></div><h3 id="113-distributed-rate-limiting">11.3 Distributed Rate Limiting</h3><p>Rate limit across a cluster using consistent hashing:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>check_rate_limit</span>(user_id):
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># User&#39;s rate limit state lives on a specific server</span>
</span></span><span style=display:flex><span>    server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(user_id)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> server<span style=color:#ff7b72;font-weight:700>.</span>check_rate_limit(user_id)
</span></span></code></pre></div><p>This ensures all requests from a user go to the same rate limiter.</p><h3 id="114-distributed-locking">11.4 Distributed Locking</h3><p>Assign locks to servers using consistent hashing:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>acquire_lock</span>(resource_id):
</span></span><span style=display:flex><span>    lock_server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(resource_id)
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> lock_server<span style=color:#ff7b72;font-weight:700>.</span>acquire(resource_id)
</span></span></code></pre></div><p>Lock conflicts are handled by a single server, simplifying coordination.</p><h2 id="12-debugging-consistent-hashing-systems">12. Debugging Consistent Hashing Systems</h2><p>When consistent hashing goes wrong, it can be challenging to diagnose. Here are the most common issues and how to debug them.</p><h3 id="121-detecting-uneven-load">12.1 Detecting Uneven Load</h3><p>Uneven load distribution is the most common problem:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>diagnose_load_distribution</span>(ring, sample_keys, expected_ratio<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1.5</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Check if load is distributed evenly across servers.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    server_counts <span style=color:#ff7b72;font-weight:700>=</span> defaultdict(int)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> key <span style=color:#ff7b72;font-weight:700>in</span> sample_keys:
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        server_counts[server] <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    counts <span style=color:#ff7b72;font-weight:700>=</span> list(server_counts<span style=color:#ff7b72;font-weight:700>.</span>values())
</span></span><span style=display:flex><span>    avg <span style=color:#ff7b72;font-weight:700>=</span> sum(counts) <span style=color:#ff7b72;font-weight:700>/</span> len(counts)
</span></span><span style=display:flex><span>    max_count <span style=color:#ff7b72;font-weight:700>=</span> max(counts)
</span></span><span style=display:flex><span>    min_count <span style=color:#ff7b72;font-weight:700>=</span> min(counts)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Average keys per server: </span><span style=color:#a5d6ff>{</span>avg<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.1f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Max/Min ratio: </span><span style=color:#a5d6ff>{</span>max_count<span style=color:#ff7b72;font-weight:700>/</span>min_count<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.2f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Coefficient of variation: </span><span style=color:#a5d6ff>{</span>statistics<span style=color:#ff7b72;font-weight:700>.</span>stdev(counts)<span style=color:#ff7b72;font-weight:700>/</span>avg<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.3f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Flag servers with disproportionate load</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> server, count <span style=color:#ff7b72;font-weight:700>in</span> server_counts<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> count <span style=color:#ff7b72;font-weight:700>&gt;</span> avg <span style=color:#ff7b72;font-weight:700>*</span> expected_ratio:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;WARNING: </span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> has </span><span style=color:#a5d6ff>{</span>count<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> keys (</span><span style=color:#a5d6ff>{</span>count<span style=color:#ff7b72;font-weight:700>/</span>avg<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.2f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>x average)&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> count <span style=color:#ff7b72;font-weight:700>&lt;</span> avg <span style=color:#ff7b72;font-weight:700>/</span> expected_ratio:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;WARNING: </span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> has only </span><span style=color:#a5d6ff>{</span>count<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> keys (</span><span style=color:#a5d6ff>{</span>count<span style=color:#ff7b72;font-weight:700>/</span>avg<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.2f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>x average)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> server_counts
</span></span></code></pre></div><p>Run this diagnostic with production-like keys to identify hot spots.</p><h3 id="122-visualizing-the-ring">12.2 Visualizing the Ring</h3><p>Visual inspection often reveals problems invisible in logs:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>visualize_ring</span>(ring, width<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>100</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Print an ASCII visualization of server positions on the ring.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    max_hash <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>2</span><span style=color:#ff7b72;font-weight:700>**</span><span style=color:#a5d6ff>32</span>
</span></span><span style=display:flex><span>    scale <span style=color:#ff7b72;font-weight:700>=</span> width <span style=color:#ff7b72;font-weight:700>/</span> max_hash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Collect all positions</span>
</span></span><span style=display:flex><span>    positions <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> server, vnodes <span style=color:#ff7b72;font-weight:700>in</span> ring<span style=color:#ff7b72;font-weight:700>.</span>virtual_nodes<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> pos <span style=color:#ff7b72;font-weight:700>in</span> vnodes:
</span></span><span style=display:flex><span>            positions<span style=color:#ff7b72;font-weight:700>.</span>append((pos, server))
</span></span><span style=display:flex><span>    positions<span style=color:#ff7b72;font-weight:700>.</span>sort()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Create visualization</span>
</span></span><span style=display:flex><span>    line <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>&#39;.&#39;</span>] <span style=color:#ff7b72;font-weight:700>*</span> width
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> pos, server <span style=color:#ff7b72;font-weight:700>in</span> positions:
</span></span><span style=display:flex><span>        idx <span style=color:#ff7b72;font-weight:700>=</span> int(pos <span style=color:#ff7b72;font-weight:700>*</span> scale)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> idx <span style=color:#ff7b72;font-weight:700>&lt;</span> width:
</span></span><span style=display:flex><span>            line[idx] <span style=color:#ff7b72;font-weight:700>=</span> server[<span style=color:#a5d6ff>0</span>]<span style=color:#ff7b72;font-weight:700>.</span>upper()  <span style=color:#8b949e;font-style:italic># First letter of server name</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#34;Ring visualization (servers as letters):&#34;</span>)
</span></span><span style=display:flex><span>    print(<span style=color:#a5d6ff>&#39;&#39;</span><span style=color:#ff7b72;font-weight:700>.</span>join(line))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Show gaps</span>
</span></span><span style=display:flex><span>    prev_pos <span style=color:#ff7b72;font-weight:700>=</span> positions[<span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>][<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>-</span> max_hash
</span></span><span style=display:flex><span>    max_gap <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>    max_gap_pos <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> pos, server <span style=color:#ff7b72;font-weight:700>in</span> positions:
</span></span><span style=display:flex><span>        gap <span style=color:#ff7b72;font-weight:700>=</span> pos <span style=color:#ff7b72;font-weight:700>-</span> prev_pos
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> gap <span style=color:#ff7b72;font-weight:700>&gt;</span> max_gap:
</span></span><span style=display:flex><span>            max_gap <span style=color:#ff7b72;font-weight:700>=</span> gap
</span></span><span style=display:flex><span>            max_gap_pos <span style=color:#ff7b72;font-weight:700>=</span> pos
</span></span><span style=display:flex><span>        prev_pos <span style=color:#ff7b72;font-weight:700>=</span> pos
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>\n</span><span style=color:#a5d6ff>Largest gap: </span><span style=color:#a5d6ff>{</span>max_gap<span style=color:#ff7b72;font-weight:700>/</span>max_hash<span style=color:#ff7b72;font-weight:700>*</span><span style=color:#a5d6ff>100</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.2f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>% of ring at position </span><span style=color:#a5d6ff>{</span>max_gap_pos<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span></code></pre></div><p>Large gaps indicate areas where one server handles a disproportionate range.</p><h3 id="123-tracing-key-routes">12.3 Tracing Key Routes</h3><p>When a specific key routes incorrectly, trace its path:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>trace_key_route</span>(key, ring, verbose<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#79c0ff>True</span>):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Trace how a key is routed through the ring.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    key_hash <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>hash_function(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> verbose:
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Key: </span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Hash: </span><span style=color:#a5d6ff>{</span>key_hash<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> (0x</span><span style=color:#a5d6ff>{</span>key_hash<span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>08x</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>)&#34;</span>)
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Ring position: </span><span style=color:#a5d6ff>{</span>key_hash <span style=color:#ff7b72;font-weight:700>/</span> <span style=color:#a5d6ff>2</span><span style=color:#ff7b72;font-weight:700>**</span><span style=color:#a5d6ff>32</span> <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>100</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>.4f</span><span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>%&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic># Find the server using binary search</span>
</span></span><span style=display:flex><span>    index <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>find_position(key_hash)
</span></span><span style=display:flex><span>    server_pos, server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>positions[index]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> verbose:
</span></span><span style=display:flex><span>        print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;Assigned to: </span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> at position </span><span style=color:#a5d6ff>{</span>server_pos<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Show nearby positions</span>
</span></span><span style=display:flex><span>        print(<span style=color:#a5d6ff>&#34;</span><span style=color:#79c0ff>\n</span><span style=color:#a5d6ff>Nearby ring positions:&#34;</span>)
</span></span><span style=display:flex><span>        start <span style=color:#ff7b72;font-weight:700>=</span> max(<span style=color:#a5d6ff>0</span>, index <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>2</span>)
</span></span><span style=display:flex><span>        end <span style=color:#ff7b72;font-weight:700>=</span> min(len(ring<span style=color:#ff7b72;font-weight:700>.</span>positions), index <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>3</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(start, end):
</span></span><span style=display:flex><span>            pos, srv <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>positions[i]
</span></span><span style=display:flex><span>            marker <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34; &lt;&lt;&#34;</span> <span style=color:#ff7b72>if</span> i <span style=color:#ff7b72;font-weight:700>==</span> index <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>&#34;&#34;</span>
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;  </span><span style=color:#a5d6ff>{</span>pos<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>: </span><span style=color:#a5d6ff>{</span>srv<span style=color:#a5d6ff>}{</span>marker<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> server
</span></span></code></pre></div><h3 id="124-detecting-ring-inconsistencies">12.4 Detecting Ring Inconsistencies</h3><p>Ensure all clients see the same ring:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>check_ring_consistency</span>(ring_configs):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Compare ring configurations across multiple clients/servers.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    reference <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> node_name, config <span style=color:#ff7b72;font-weight:700>in</span> ring_configs<span style=color:#ff7b72;font-weight:700>.</span>items():
</span></span><span style=display:flex><span>        ring <span style=color:#ff7b72;font-weight:700>=</span> ConsistentHash<span style=color:#ff7b72;font-weight:700>.</span>from_config(config)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> reference <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>            reference <span style=color:#ff7b72;font-weight:700>=</span> (node_name, ring)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ref_name, ref_ring <span style=color:#ff7b72;font-weight:700>=</span> reference
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Compare server lists</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> set(ring<span style=color:#ff7b72;font-weight:700>.</span>servers) <span style=color:#ff7b72;font-weight:700>!=</span> set(ref_ring<span style=color:#ff7b72;font-weight:700>.</span>servers):
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;SERVER MISMATCH: </span><span style=color:#a5d6ff>{</span>node_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> vs </span><span style=color:#a5d6ff>{</span>ref_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;  Only in </span><span style=color:#a5d6ff>{</span>node_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>: </span><span style=color:#a5d6ff>{</span>set(ring<span style=color:#ff7b72;font-weight:700>.</span>servers) <span style=color:#ff7b72;font-weight:700>-</span> set(ref_ring<span style=color:#ff7b72;font-weight:700>.</span>servers)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;  Only in </span><span style=color:#a5d6ff>{</span>ref_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>: </span><span style=color:#a5d6ff>{</span>set(ref_ring<span style=color:#ff7b72;font-weight:700>.</span>servers) <span style=color:#ff7b72;font-weight:700>-</span> set(ring<span style=color:#ff7b72;font-weight:700>.</span>servers)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Compare virtual node counts</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> server <span style=color:#ff7b72;font-weight:700>in</span> ring<span style=color:#ff7b72;font-weight:700>.</span>servers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_weight(server) <span style=color:#ff7b72;font-weight:700>!=</span> ref_ring<span style=color:#ff7b72;font-weight:700>.</span>get_weight(server):
</span></span><span style=display:flex><span>                print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;WEIGHT MISMATCH: </span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>                print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;  </span><span style=color:#a5d6ff>{</span>node_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>: </span><span style=color:#a5d6ff>{</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_weight(server)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>                print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;  </span><span style=color:#a5d6ff>{</span>ref_name<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>: </span><span style=color:#a5d6ff>{</span>ref_ring<span style=color:#ff7b72;font-weight:700>.</span>get_weight(server)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Test sample keys</span>
</span></span><span style=display:flex><span>        test_keys <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;test-key-</span><span style=color:#a5d6ff>{</span>i<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span> <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(<span style=color:#a5d6ff>1000</span>)]
</span></span><span style=display:flex><span>        misroutes <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> key <span style=color:#ff7b72;font-weight:700>in</span> test_keys:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key) <span style=color:#ff7b72;font-weight:700>!=</span> ref_ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key):
</span></span><span style=display:flex><span>                misroutes <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> misroutes <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span>:
</span></span><span style=display:flex><span>            print(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;ROUTING MISMATCH: </span><span style=color:#a5d6ff>{</span>misroutes<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>/</span><span style=color:#a5d6ff>{</span>len(test_keys)<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff> keys route differently&#34;</span>)
</span></span></code></pre></div><h3 id="125-monitoring-health-metrics">12.5 Monitoring Health Metrics</h3><p>Essential metrics for consistent hashing systems:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ConsistentHashMetrics</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, ring):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ring
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>stats <span style=color:#ff7b72;font-weight:700>=</span> defaultdict(<span style=color:#ff7b72>lambda</span>: {<span style=color:#a5d6ff>&#34;requests&#34;</span>: <span style=color:#a5d6ff>0</span>, <span style=color:#a5d6ff>&#34;bytes&#34;</span>: <span style=color:#a5d6ff>0</span>, <span style=color:#a5d6ff>&#34;latency_sum&#34;</span>: <span style=color:#a5d6ff>0</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>record_request</span>(self, key, bytes_transferred, latency_ms):
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>stats[server][<span style=color:#a5d6ff>&#34;requests&#34;</span>] <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>stats[server][<span style=color:#a5d6ff>&#34;bytes&#34;</span>] <span style=color:#ff7b72;font-weight:700>+=</span> bytes_transferred
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>stats[server][<span style=color:#a5d6ff>&#34;latency_sum&#34;</span>] <span style=color:#ff7b72;font-weight:700>+=</span> latency_ms
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_report</span>(self):
</span></span><span style=display:flex><span>        report <span style=color:#ff7b72;font-weight:700>=</span> []
</span></span><span style=display:flex><span>        total_requests <span style=color:#ff7b72;font-weight:700>=</span> sum(s[<span style=color:#a5d6ff>&#34;requests&#34;</span>] <span style=color:#ff7b72>for</span> s <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>stats<span style=color:#ff7b72;font-weight:700>.</span>values())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> server, stats <span style=color:#ff7b72;font-weight:700>in</span> sorted(self<span style=color:#ff7b72;font-weight:700>.</span>stats<span style=color:#ff7b72;font-weight:700>.</span>items()):
</span></span><span style=display:flex><span>            pct <span style=color:#ff7b72;font-weight:700>=</span> stats[<span style=color:#a5d6ff>&#34;requests&#34;</span>] <span style=color:#ff7b72;font-weight:700>/</span> total_requests <span style=color:#ff7b72;font-weight:700>*</span> <span style=color:#a5d6ff>100</span> <span style=color:#ff7b72>if</span> total_requests <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>            avg_latency <span style=color:#ff7b72;font-weight:700>=</span> stats[<span style=color:#a5d6ff>&#34;latency_sum&#34;</span>] <span style=color:#ff7b72;font-weight:700>/</span> stats[<span style=color:#a5d6ff>&#34;requests&#34;</span>] <span style=color:#ff7b72>if</span> stats[<span style=color:#a5d6ff>&#34;requests&#34;</span>] <span style=color:#ff7b72;font-weight:700>&gt;</span> <span style=color:#a5d6ff>0</span> <span style=color:#ff7b72>else</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            report<span style=color:#ff7b72;font-weight:700>.</span>append({
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;server&#34;</span>: server,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;requests&#34;</span>: stats[<span style=color:#a5d6ff>&#34;requests&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;request_pct&#34;</span>: pct,
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;bytes&#34;</span>: stats[<span style=color:#a5d6ff>&#34;bytes&#34;</span>],
</span></span><span style=display:flex><span>                <span style=color:#a5d6ff>&#34;avg_latency_ms&#34;</span>: avg_latency
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> report
</span></span></code></pre></div><p>Key metrics to monitor:</p><ul><li><strong>Request distribution:</strong> Should be proportional to server weights</li><li><strong>Latency by server:</strong> High latency may indicate overload</li><li><strong>Cache hit rates:</strong> Per-server to detect cold servers after rebalancing</li><li><strong>Data size distribution:</strong> Some servers may hold larger values</li></ul><h2 id="13-consistent-hashing-in-different-languages">13. Consistent Hashing in Different Languages</h2><h3 id="131-go-implementation">13.1 Go Implementation</h3><p>Go&rsquo;s strong concurrency support makes it ideal for distributed systems:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-go" data-lang=go><span style=display:flex><span><span style=color:#ff7b72>package</span><span style=color:#6e7681> </span>consistenthash<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span>(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#a5d6ff>&#34;hash/crc32&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#a5d6ff>&#34;sort&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#a5d6ff>&#34;strconv&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#a5d6ff>&#34;sync&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>type</span><span style=color:#6e7681> </span>Ring<span style=color:#6e7681> </span><span style=color:#ff7b72>struct</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>mu<span style=color:#6e7681>       </span>sync.RWMutex<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>nodes<span style=color:#6e7681>    </span><span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>uint32</span>]<span style=color:#ff7b72>string</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>sorted<span style=color:#6e7681>   </span>[]<span style=color:#ff7b72>uint32</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>replicas<span style=color:#6e7681> </span><span style=color:#ff7b72>int</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>func</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>New</span>(replicas<span style=color:#6e7681> </span><span style=color:#ff7b72>int</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span>Ring<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;</span>Ring{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>nodes:<span style=color:#6e7681>    </span>make(<span style=color:#ff7b72>map</span>[<span style=color:#ff7b72>uint32</span>]<span style=color:#ff7b72>string</span>),<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>replicas:<span style=color:#6e7681> </span>replicas,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>func</span><span style=color:#6e7681> </span>(r<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span>Ring)<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>Add</span>(node<span style=color:#6e7681> </span><span style=color:#ff7b72>string</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>r.mu.<span style=color:#d2a8ff;font-weight:700>Lock</span>()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>defer</span><span style=color:#6e7681> </span>r.mu.<span style=color:#d2a8ff;font-weight:700>Unlock</span>()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>:=</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span>;<span style=color:#6e7681> </span>i<span style=color:#6e7681> </span>&lt;<span style=color:#6e7681> </span>r.replicas;<span style=color:#6e7681> </span>i<span style=color:#ff7b72;font-weight:700>++</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>:=</span><span style=color:#6e7681> </span>crc32.<span style=color:#d2a8ff;font-weight:700>ChecksumIEEE</span>([]byte(strconv.<span style=color:#d2a8ff;font-weight:700>Itoa</span>(i)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>node))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>r.nodes[hash]<span style=color:#6e7681> </span>=<span style=color:#6e7681> </span>node<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>r.sorted<span style=color:#6e7681> </span>=<span style=color:#6e7681> </span>append(r.sorted,<span style=color:#6e7681> </span>hash)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>sort.<span style=color:#d2a8ff;font-weight:700>Slice</span>(r.sorted,<span style=color:#6e7681> </span><span style=color:#ff7b72>func</span>(i,<span style=color:#6e7681> </span>j<span style=color:#6e7681> </span><span style=color:#ff7b72>int</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>bool</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>r.sorted[i]<span style=color:#6e7681> </span>&lt;<span style=color:#6e7681> </span>r.sorted[j]<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>})<span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>func</span><span style=color:#6e7681> </span>(r<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span>Ring)<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>Get</span>(key<span style=color:#6e7681> </span><span style=color:#ff7b72>string</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>string</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>r.mu.<span style=color:#d2a8ff;font-weight:700>RLock</span>()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>defer</span><span style=color:#6e7681> </span>r.mu.<span style=color:#d2a8ff;font-weight:700>RUnlock</span>()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>len(r.sorted)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>==</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;&#34;</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>:=</span><span style=color:#6e7681> </span>crc32.<span style=color:#d2a8ff;font-weight:700>ChecksumIEEE</span>([]byte(key))<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>idx<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>:=</span><span style=color:#6e7681> </span>sort.<span style=color:#d2a8ff;font-weight:700>Search</span>(len(r.sorted),<span style=color:#6e7681> </span><span style=color:#ff7b72>func</span>(i<span style=color:#6e7681> </span><span style=color:#ff7b72>int</span>)<span style=color:#6e7681> </span><span style=color:#ff7b72>bool</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>r.sorted[i]<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;=</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>})<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>idx<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&gt;=</span><span style=color:#6e7681> </span>len(r.sorted)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>idx<span style=color:#6e7681> </span>=<span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>r.nodes[r.sorted[idx]]<span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id="132-rust-implementation">13.2 Rust Implementation</h3><p>Rust&rsquo;s ownership model prevents common concurrency bugs:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-rust" data-lang=rust><span style=display:flex><span><span style=color:#ff7b72>use</span><span style=color:#6e7681> </span>std::collections::BTreeMap;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>use</span><span style=color:#6e7681> </span>std::hash::{Hash,<span style=color:#6e7681> </span>Hasher};<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>use</span><span style=color:#6e7681> </span>std::collections::hash_map::DefaultHasher;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>pub</span><span style=color:#6e7681> </span><span style=color:#ff7b72>struct</span> <span style=color:#f0883e;font-weight:700>ConsistentHash</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>ring: <span style=color:#f0883e;font-weight:700>BTreeMap</span><span style=color:#ff7b72;font-weight:700>&lt;</span><span style=color:#ff7b72>u64</span>,<span style=color:#6e7681> </span>String<span style=color:#ff7b72;font-weight:700>&gt;</span>,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>replicas: <span style=color:#ff7b72>usize</span>,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>impl</span><span style=color:#6e7681> </span>ConsistentHash<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>pub</span><span style=color:#6e7681> </span><span style=color:#ff7b72>fn</span> <span style=color:#d2a8ff;font-weight:700>new</span>(replicas: <span style=color:#ff7b72>usize</span>)<span style=color:#6e7681> </span>-&gt; <span style=color:#f0883e;font-weight:700>Self</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>ConsistentHash<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>ring: <span style=color:#f0883e;font-weight:700>BTreeMap</span>::new(),<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>replicas,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>fn</span> <span style=color:#d2a8ff;font-weight:700>hash</span><span style=color:#ff7b72;font-weight:700>&lt;</span>T: <span style=color:#f0883e;font-weight:700>Hash</span><span style=color:#ff7b72;font-weight:700>&gt;</span>(t: <span style=color:#79c0ff>&amp;</span><span style=color:#f0883e;font-weight:700>T</span>)<span style=color:#6e7681> </span>-&gt; <span style=color:#ff7b72>u64</span> {<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>let</span><span style=color:#6e7681> </span><span style=color:#ff7b72>mut</span><span style=color:#6e7681> </span>hasher<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>DefaultHasher::new();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>t.hash(<span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#ff7b72>mut</span><span style=color:#6e7681> </span>hasher);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>hasher.finish()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>pub</span><span style=color:#6e7681> </span><span style=color:#ff7b72>fn</span> <span style=color:#d2a8ff;font-weight:700>add</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#ff7b72>mut</span><span style=color:#6e7681> </span>self,<span style=color:#6e7681> </span>node: <span style=color:#79c0ff>&amp;</span><span style=color:#ff7b72>str</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72>in</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#ff7b72;font-weight:700>..</span>self.replicas<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>let</span><span style=color:#6e7681> </span>key<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>format!</span>(<span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>{}</span><span style=color:#a5d6ff>&#34;</span>,<span style=color:#6e7681> </span>node,<span style=color:#6e7681> </span>i);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>let</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>Self::hash(<span style=color:#ff7b72;font-weight:700>&amp;</span>key);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>self.ring.insert(hash,<span style=color:#6e7681> </span>node.to_string());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>pub</span><span style=color:#6e7681> </span><span style=color:#ff7b72>fn</span> <span style=color:#d2a8ff;font-weight:700>remove</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#ff7b72>mut</span><span style=color:#6e7681> </span>self,<span style=color:#6e7681> </span>node: <span style=color:#79c0ff>&amp;</span><span style=color:#ff7b72>str</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72>in</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>0</span><span style=color:#ff7b72;font-weight:700>..</span>self.replicas<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>let</span><span style=color:#6e7681> </span>key<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>format!</span>(<span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{}</span><span style=color:#a5d6ff>:</span><span style=color:#a5d6ff>{}</span><span style=color:#a5d6ff>&#34;</span>,<span style=color:#6e7681> </span>node,<span style=color:#6e7681> </span>i);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>let</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>Self::hash(<span style=color:#ff7b72;font-weight:700>&amp;</span>key);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>self.ring.remove(<span style=color:#ff7b72;font-weight:700>&amp;</span>hash);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>pub</span><span style=color:#6e7681> </span><span style=color:#ff7b72>fn</span> <span style=color:#d2a8ff;font-weight:700>get</span>(<span style=color:#ff7b72;font-weight:700>&amp;</span>self,<span style=color:#6e7681> </span>key: <span style=color:#79c0ff>&amp;</span><span style=color:#ff7b72>str</span>)<span style=color:#6e7681> </span>-&gt; Option<span style=color:#ff7b72;font-weight:700>&lt;&amp;</span>String<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>self.ring.is_empty()<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>None;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>let</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>Self::hash(<span style=color:#ff7b72;font-weight:700>&amp;</span>key);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#8b949e;font-style:italic>// Find the first node with hash &gt;= key&#39;s hash
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>self.ring.range(hash<span style=color:#ff7b72;font-weight:700>..</span>).next()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.or_else(<span style=color:#ff7b72;font-weight:700>||</span><span style=color:#6e7681> </span>self.ring.iter().next())<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>.map(<span style=color:#ff7b72;font-weight:700>|</span>(_,<span style=color:#6e7681> </span>node)<span style=color:#ff7b72;font-weight:700>|</span><span style=color:#6e7681> </span>node)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h3 id="133-java-implementation">13.3 Java Implementation</h3><p>Enterprise systems often use Java with its mature ecosystem:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-java" data-lang=java><span style=display:flex><span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.SortedMap</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.util.TreeMap</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>import</span><span style=color:#6e7681> </span><span style=color:#ff7b72>java.security.MessageDigest</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>ConsistentHash</span><span style=color:#ff7b72;font-weight:700>&lt;</span>T<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span><span style=color:#ff7b72>int</span><span style=color:#6e7681> </span>replicas;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>final</span><span style=color:#6e7681> </span>SortedMap<span style=color:#ff7b72;font-weight:700>&lt;</span>Long,<span style=color:#6e7681> </span>T<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>ring<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>TreeMap<span style=color:#ff7b72;font-weight:700>&lt;&gt;</span>();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>ConsistentHash</span>(<span style=color:#ff7b72>int</span><span style=color:#6e7681> </span>replicas)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>this</span>.replicas<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>replicas;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>add</span>(T<span style=color:#6e7681> </span>node)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>(<span style=color:#ff7b72>int</span><span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>0;<span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&lt;</span><span style=color:#6e7681> </span>replicas;<span style=color:#6e7681> </span>i<span style=color:#ff7b72;font-weight:700>++</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>long</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>hash(node.toString()<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;:&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>i);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>ring.put(hash,<span style=color:#6e7681> </span>node);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span><span style=color:#ff7b72>void</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>remove</span>(T<span style=color:#6e7681> </span>node)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>for</span><span style=color:#6e7681> </span>(<span style=color:#ff7b72>int</span><span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>0;<span style=color:#6e7681> </span>i<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&lt;</span><span style=color:#6e7681> </span>replicas;<span style=color:#6e7681> </span>i<span style=color:#ff7b72;font-weight:700>++</span>)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>long</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>hash(node.toString()<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span><span style=color:#a5d6ff>&#34;:&#34;</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>+</span><span style=color:#6e7681> </span>i);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>ring.remove(hash);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>public</span><span style=color:#6e7681> </span>T<span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>get</span>(String<span style=color:#6e7681> </span>key)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>if</span><span style=color:#6e7681> </span>(ring.isEmpty())<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span><span style=color:#79c0ff>null</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>long</span><span style=color:#6e7681> </span>hash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>hash(key);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#8b949e;font-style:italic>// Find the first entry with hash &gt;= key&#39;s hash</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>SortedMap<span style=color:#ff7b72;font-weight:700>&lt;</span>Long,<span style=color:#6e7681> </span>T<span style=color:#ff7b72;font-weight:700>&gt;</span><span style=color:#6e7681> </span>tailMap<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>ring.tailMap(hash);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>Long<span style=color:#6e7681> </span>nodeHash<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>tailMap.isEmpty()<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>?</span><span style=color:#6e7681> </span>ring.firstKey()<span style=color:#6e7681> </span>:<span style=color:#6e7681> </span>tailMap.firstKey();<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>ring.get(nodeHash);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>private</span><span style=color:#6e7681> </span><span style=color:#ff7b72>long</span><span style=color:#6e7681> </span><span style=color:#d2a8ff;font-weight:700>hash</span>(String<span style=color:#6e7681> </span>key)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span><span style=color:#ff7b72>try</span><span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span>MessageDigest<span style=color:#6e7681> </span>md<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>MessageDigest.getInstance(<span style=color:#a5d6ff>&#34;MD5&#34;</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>byte</span><span style=color:#ff7b72;font-weight:700>[]</span><span style=color:#6e7681> </span>digest<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span>md.digest(key.getBytes());<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>return</span><span style=color:#6e7681> </span>((<span style=color:#ff7b72>long</span>)(digest<span style=color:#ff7b72;font-weight:700>[</span>3<span style=color:#ff7b72;font-weight:700>]</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#6e7681> </span>0xFF)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&lt;&lt;</span><span style=color:#6e7681> </span>24)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>|</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                   </span>((<span style=color:#ff7b72>long</span>)(digest<span style=color:#ff7b72;font-weight:700>[</span>2<span style=color:#ff7b72;font-weight:700>]</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#6e7681> </span>0xFF)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&lt;&lt;</span><span style=color:#6e7681> </span>16)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>|</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                   </span>((<span style=color:#ff7b72>long</span>)(digest<span style=color:#ff7b72;font-weight:700>[</span>1<span style=color:#ff7b72;font-weight:700>]</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#6e7681> </span>0xFF)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&lt;&lt;</span><span style=color:#6e7681> </span>8)<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>|</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>                   </span>((<span style=color:#ff7b72>long</span>)(digest<span style=color:#ff7b72;font-weight:700>[</span>0<span style=color:#ff7b72;font-weight:700>]</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>&amp;</span><span style=color:#6e7681> </span>0xFF));<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681> </span><span style=color:#ff7b72>catch</span><span style=color:#6e7681> </span>(Exception<span style=color:#6e7681> </span>e)<span style=color:#6e7681> </span>{<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>            </span><span style=color:#ff7b72>throw</span><span style=color:#6e7681> </span><span style=color:#ff7b72>new</span><span style=color:#6e7681> </span>RuntimeException(e);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>        </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>}<span style=color:#6e7681>
</span></span></span><span style=display:flex><span>}<span style=color:#6e7681>
</span></span></span></code></pre></div><h2 id="14-history-and-evolution">14. History and Evolution</h2><h3 id="141-origins-at-akamai">14.1 Origins at Akamai</h3><p>Consistent hashing was invented in 1997 by David Karger and colleagues at MIT, originally to solve web caching problems at Akamai. The insight was that traditional hashing schemes couldn&rsquo;t handle the dynamic nature of CDN edge servers—nodes join and leave frequently, and the system needed to continue operating smoothly.</p><p>The original paper, &ldquo;Consistent Hashing and Random Trees: Distributed Caching Protocols for Relieving Hot Spots on the World Wide Web,&rdquo; laid the theoretical foundations that still guide implementations today.</p><h3 id="142-amazon-dynamo">14.2 Amazon Dynamo</h3><p>Amazon&rsquo;s Dynamo paper (2007) brought consistent hashing to mainstream distributed databases. Key innovations included:</p><ul><li><strong>Virtual nodes:</strong> Solving the load balance problem with replicated ring positions</li><li><strong>Preference lists:</strong> Extending beyond a single responsible node to replica sets</li><li><strong>Sloppy quorum:</strong> Allowing writes to proceed when some nodes are unavailable</li><li><strong>Hinted handoff:</strong> Ensuring data reaches its intended location eventually</li></ul><p>Dynamo&rsquo;s design influenced DynamoDB, Cassandra, Riak, and countless other systems.</p><h3 id="143-maglev-at-google">14.3 Maglev at Google</h3><p>Google&rsquo;s Maglev paper (2016) introduced a new approach optimized for network load balancing. The key insight was that load balancers need O(1) lookup (achieved via lookup tables) more than they need minimal disruption (since connection tracking handles in-flight requests anyway).</p><h3 id="144-modern-variations">14.4 Modern Variations</h3><p>Recent innovations include:</p><ul><li><strong>Bounded-load consistent hashing:</strong> Caps the load on any server, sacrificing some consistency for better balance</li><li><strong>Multi-probe consistent hashing:</strong> Multiple hash probes reduce variance without virtual nodes</li><li><strong>Consistent hashing with bounded loads:</strong> Google&rsquo;s approach combining load balancing with consistency</li></ul><h2 id="15-war-stories-and-real-world-lessons">15. War Stories and Real-World Lessons</h2><h3 id="151-the-hot-partition-problem">15.1 The Hot Partition Problem</h3><p>A social media platform experienced severe degradation when a viral post caused millions of requests for the same key. The consistent hashing ring dutifully routed all requests to a single server, which promptly buckled under the load.</p><p>The solution involved multiple strategies:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get_with_hot_key_handling</span>(key):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Handle hot keys by spreading across replicas.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>if</span> is_hot_key(key):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Add randomness to spread load</span>
</span></span><span style=display:flex><span>        suffix <span style=color:#ff7b72;font-weight:700>=</span> random<span style=color:#ff7b72;font-weight:700>.</span>randint(<span style=color:#a5d6ff>0</span>, NUM_HOT_REPLICAS <span style=color:#ff7b72;font-weight:700>-</span> <span style=color:#a5d6ff>1</span>)
</span></span><span style=display:flex><span>        effective_key <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;</span><span style=color:#a5d6ff>{</span>key<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>:hot:</span><span style=color:#a5d6ff>{</span>suffix<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(effective_key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Try primary replicas first</span>
</span></span><span style=display:flex><span>        value <span style=color:#ff7b72;font-weight:700>=</span> server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> value <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#8b949e;font-style:italic># Fall back to original server</span>
</span></span><span style=display:flex><span>            server <span style=color:#ff7b72;font-weight:700>=</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>            value <span style=color:#ff7b72;font-weight:700>=</span> server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> value
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>is_hot_key</span>(key):
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;&#34;&#34;Detect hot keys using a counting bloom filter or local stats.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> hot_key_detector<span style=color:#ff7b72;font-weight:700>.</span>is_hot(key)
</span></span></code></pre></div><p>Alternatively, use a small in-memory cache in front of the consistent hash:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>HotKeyCache</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, ring, hot_cache_size<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1000</span>):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ring
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>hot_cache <span style=color:#ff7b72;font-weight:700>=</span> LRUCache(hot_cache_size)
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>access_counts <span style=color:#ff7b72;font-weight:700>=</span> defaultdict(int)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get</span>(self, key):
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Check hot cache first</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> key <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>hot_cache:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>hot_cache[key]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Get from normal path</span>
</span></span><span style=display:flex><span>        server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>        value <span style=color:#ff7b72;font-weight:700>=</span> server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Track access and potentially cache</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>access_counts[key] <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> self<span style=color:#ff7b72;font-weight:700>.</span>access_counts[key] <span style=color:#ff7b72;font-weight:700>&gt;</span> HOT_THRESHOLD:
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>hot_cache[key] <span style=color:#ff7b72;font-weight:700>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> value
</span></span></code></pre></div><h3 id="152-the-phantom-server">15.2 The Phantom Server</h3><p>A cluster experienced mysterious data loss after a network partition healed. Investigation revealed that during the partition, two halves of the cluster had independently decided to remove &ldquo;unreachable&rdquo; servers from their rings. When connectivity restored, each half had data that the other expected to be elsewhere.</p><p>The lesson: ring configuration changes must go through a consensus mechanism. Never let individual nodes unilaterally modify the ring topology.</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>SafeRingManager</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, coordination_service):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>zk <span style=color:#ff7b72;font-weight:700>=</span> coordination_service
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ConsistentHash()
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>watch_ring_changes()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>watch_ring_changes</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;Subscribe to ring configuration changes.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#d2a8ff;font-weight:700>@self.zk.watch</span>(<span style=color:#a5d6ff>&#34;/ring/servers&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>on_change</span>(servers):
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>ring <span style=color:#ff7b72;font-weight:700>=</span> ConsistentHash()
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> server <span style=color:#ff7b72;font-weight:700>in</span> servers:
</span></span><span style=display:flex><span>                config <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>zk<span style=color:#ff7b72;font-weight:700>.</span>get(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;/ring/servers/</span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>)
</span></span><span style=display:flex><span>                self<span style=color:#ff7b72;font-weight:700>.</span>ring<span style=color:#ff7b72;font-weight:700>.</span>add_server(server, weight<span style=color:#ff7b72;font-weight:700>=</span>config<span style=color:#ff7b72;font-weight:700>.</span>weight)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>propose_remove_server</span>(self, server):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;Propose server removal through consensus.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#8b949e;font-style:italic># Don&#39;t directly modify - let consensus decide</span>
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>zk<span style=color:#ff7b72;font-weight:700>.</span>create(<span style=color:#79c0ff>f</span><span style=color:#a5d6ff>&#34;/ring/proposals/remove-</span><span style=color:#a5d6ff>{</span>server<span style=color:#a5d6ff>}</span><span style=color:#a5d6ff>&#34;</span>,
</span></span><span style=display:flex><span>                       data<span style=color:#ff7b72;font-weight:700>=</span>{<span style=color:#a5d6ff>&#34;server&#34;</span>: server, <span style=color:#a5d6ff>&#34;reason&#34;</span>: <span style=color:#a5d6ff>&#34;unhealthy&#34;</span>})
</span></span></code></pre></div><h3 id="153-the-slow-migration">15.3 The Slow Migration</h3><p>A database migration used lazy rebalancing to move data to new shards. After weeks, significant data remained unmigrated because some keys were rarely accessed. The long tail of cold data can take indefinitely to migrate with lazy approaches.</p><p>The hybrid solution combined lazy and proactive migration:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>HybridMigration</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, old_ring, new_ring):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>old_ring <span style=color:#ff7b72;font-weight:700>=</span> old_ring
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>new_ring <span style=color:#ff7b72;font-weight:700>=</span> new_ring
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>migrated <span style=color:#ff7b72;font-weight:700>=</span> set()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>get</span>(self, key):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;Lazy migration on read.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        new_server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>new_ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> key <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>migrated:
</span></span><span style=display:flex><span>            value <span style=color:#ff7b72;font-weight:700>=</span> new_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>if</span> value <span style=color:#ff7b72;font-weight:700>is</span> <span style=color:#79c0ff>None</span>:
</span></span><span style=display:flex><span>                <span style=color:#8b949e;font-style:italic># Migrate on access</span>
</span></span><span style=display:flex><span>                old_server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>old_ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>                value <span style=color:#ff7b72;font-weight:700>=</span> old_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> value:
</span></span><span style=display:flex><span>                    new_server<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)
</span></span><span style=display:flex><span>                    self<span style=color:#ff7b72;font-weight:700>.</span>migrated<span style=color:#ff7b72;font-weight:700>.</span>add(key)
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>            value <span style=color:#ff7b72;font-weight:700>=</span> new_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>background_migrate</span>(self, batch_size<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>1000</span>):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;Proactive migration of cold data.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> old_server <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>old_ring<span style=color:#ff7b72;font-weight:700>.</span>servers:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>for</span> key <span style=color:#ff7b72;font-weight:700>in</span> old_server<span style=color:#ff7b72;font-weight:700>.</span>scan_keys(batch_size):
</span></span><span style=display:flex><span>                <span style=color:#ff7b72>if</span> key <span style=color:#ff7b72;font-weight:700>not</span> <span style=color:#ff7b72;font-weight:700>in</span> self<span style=color:#ff7b72;font-weight:700>.</span>migrated:
</span></span><span style=display:flex><span>                    new_server <span style=color:#ff7b72;font-weight:700>=</span> self<span style=color:#ff7b72;font-weight:700>.</span>new_ring<span style=color:#ff7b72;font-weight:700>.</span>get_server(key)
</span></span><span style=display:flex><span>                    <span style=color:#ff7b72>if</span> new_server <span style=color:#ff7b72;font-weight:700>!=</span> old_server:
</span></span><span style=display:flex><span>                        value <span style=color:#ff7b72;font-weight:700>=</span> old_server<span style=color:#ff7b72;font-weight:700>.</span>get(key)
</span></span><span style=display:flex><span>                        new_server<span style=color:#ff7b72;font-weight:700>.</span>put(key, value)
</span></span><span style=display:flex><span>                        self<span style=color:#ff7b72;font-weight:700>.</span>migrated<span style=color:#ff7b72;font-weight:700>.</span>add(key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    rate_limiter<span style=color:#ff7b72;font-weight:700>.</span>wait()  <span style=color:#8b949e;font-style:italic># Don&#39;t overwhelm the system</span>
</span></span></code></pre></div><h3 id="154-clock-skew-chaos">15.4 Clock Skew Chaos</h3><p>A distributed cache used timestamps to determine data freshness. Clock skew between servers caused newer data to be overwritten by older data during replication. The consistent hashing was correct, but the conflict resolution was broken.</p><p>Use logical clocks or vector clocks instead of wall clocks:</p><div class="highlight"><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class="language-python" data-lang=python><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>LamportTimestamp</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>counter <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>increment</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>counter <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>counter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>update</span>(self, received_timestamp):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>counter <span style=color:#ff7b72;font-weight:700>=</span> max(self<span style=color:#ff7b72;font-weight:700>.</span>counter, received_timestamp) <span style=color:#ff7b72;font-weight:700>+</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>counter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>class</span> <span style=color:#f0883e;font-weight:700>VectorClock</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>__init__</span>(self, node_id, num_nodes):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>node_id <span style=color:#ff7b72;font-weight:700>=</span> node_id
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>clock <span style=color:#ff7b72;font-weight:700>=</span> [<span style=color:#a5d6ff>0</span>] <span style=color:#ff7b72;font-weight:700>*</span> num_nodes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>increment</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>clock[self<span style=color:#ff7b72;font-weight:700>.</span>node_id] <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>return</span> self<span style=color:#ff7b72;font-weight:700>.</span>clock<span style=color:#ff7b72;font-weight:700>.</span>copy()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>update</span>(self, received_clock):
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>for</span> i <span style=color:#ff7b72;font-weight:700>in</span> range(len(self<span style=color:#ff7b72;font-weight:700>.</span>clock)):
</span></span><span style=display:flex><span>            self<span style=color:#ff7b72;font-weight:700>.</span>clock[i] <span style=color:#ff7b72;font-weight:700>=</span> max(self<span style=color:#ff7b72;font-weight:700>.</span>clock[i], received_clock[i])
</span></span><span style=display:flex><span>        self<span style=color:#ff7b72;font-weight:700>.</span>clock[self<span style=color:#ff7b72;font-weight:700>.</span>node_id] <span style=color:#ff7b72;font-weight:700>+=</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>def</span> <span style=color:#d2a8ff;font-weight:700>compare</span>(self, other):
</span></span><span style=display:flex><span>        <span style=color:#a5d6ff>&#34;&#34;&#34;Returns: -1 (before), 0 (concurrent), 1 (after)&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        less <span style=color:#ff7b72;font-weight:700>=</span> any(s <span style=color:#ff7b72;font-weight:700>&lt;</span> o <span style=color:#ff7b72>for</span> s, o <span style=color:#ff7b72;font-weight:700>in</span> zip(self<span style=color:#ff7b72;font-weight:700>.</span>clock, other))
</span></span><span style=display:flex><span>        greater <span style=color:#ff7b72;font-weight:700>=</span> any(s <span style=color:#ff7b72;font-weight:700>&gt;</span> o <span style=color:#ff7b72>for</span> s, o <span style=color:#ff7b72;font-weight:700>in</span> zip(self<span style=color:#ff7b72;font-weight:700>.</span>clock, other))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>if</span> less <span style=color:#ff7b72;font-weight:700>and</span> <span style=color:#ff7b72;font-weight:700>not</span> greater:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#ff7b72;font-weight:700>-</span><span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>elif</span> greater <span style=color:#ff7b72;font-weight:700>and</span> <span style=color:#ff7b72;font-weight:700>not</span> less:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#ff7b72>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff7b72>return</span> <span style=color:#a5d6ff>0</span>  <span style=color:#8b949e;font-style:italic># Concurrent - need application-level resolution</span>
</span></span></code></pre></div><h2 id="16-summary">16. Summary</h2><p>Consistent hashing is a foundational algorithm for distributed systems:</p><ul><li><strong>Minimal disruption:</strong> Adding or removing servers moves only K/N keys</li><li><strong>Load balance:</strong> Virtual nodes ensure even distribution</li><li><strong>Scalability:</strong> Supports thousands of servers efficiently</li><li><strong>Flexibility:</strong> Handles heterogeneous servers, replication, and failures</li></ul><p>Key takeaways:</p><ol><li><strong>Use virtual nodes</strong> (100-200 per server) for load balance</li><li><strong>Choose the right hash function:</strong> Fast, uniform, deterministic</li><li><strong>Consider alternatives:</strong> Jump hash for numbered shards, Maglev for O(1) lookup</li><li><strong>Handle failures gracefully:</strong> Health checks, sloppy quorum, hinted handoff</li><li><strong>Maintain ring consistency:</strong> Use a coordination service</li><li><strong>Monitor and debug:</strong> Track load distribution, visualize the ring, compare configurations</li></ol><p>From DynamoDB to Cassandra to your local Memcached cluster, consistent hashing enables the distributed systems that power the modern internet. Understanding it deeply transforms how you architect scalable systems.</p><p>The elegance of consistent hashing lies in its simplicity: by mapping both servers and keys to the same space, it achieves minimal disruption through pure geometry. That&rsquo;s the kind of algorithm that makes you appreciate computer science.</p></div><footer class="ce1a612 c6dfb1e c3ecea6"><div class="c364589">Categories:
<a href=/categories/systems/>systems</a>, <a href=/categories/distributed/>distributed</a></div><div>Tags:
<a href=/tags/distributed-systems/>#distributed-systems</a>, <a href=/tags/consistent-hashing/>#consistent-hashing</a>, <a href=/tags/scalability/>#scalability</a>, <a href=/tags/load-balancing/>#load-balancing</a>, <a href=/tags/databases/>#databases</a>, <a href=/tags/caching/>#caching</a></div></footer></article></main><footer class="ccdf0e8" role=contentinfo aria-label=Footer><div class="cfdda01 c133889 c5df473 c0eecc8 c69618a c6942b3 c03620d c2a9f27 c7c11d8 c82c52d c14527b"><div class="c6dfb1e c3ecea6 c39ef11 c88ae6f">&copy; 2026 Leonardo Benicio. All rights
reserved.</div><div class="c6942b3 c7c11d8 cd1fd22"><a href=https://github.com/lbenicio target=_blank rel="noopener noreferrer" aria-label=GitHub class="c1d6c20 c7c11d8 c1d0018 cd1fd22 cb5c327 c10dda9 c6dfb1e cbbda39 cfc01c7 c01f421 c286dd7 c2bd687 cfdce1d cfef18f c000b66 cf55a7b c514027"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8.0 00-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35.0-3.5.0.0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35.0 3.5A5.403 5.403.0 004 9c0 3.5 3 5.5 6 5.5-.39.5-.67 1.08-.82 1.7s-.2 1.27-.18 1.9V22"/></svg>
<span class="cba5854">GitHub</span>
</a><a href=https://www.linkedin.com/in/leonardo-benicio target=_blank rel="noopener noreferrer" aria-label=LinkedIn class="c1d6c20 c7c11d8 c1d0018 cd1fd22 cb5c327 c10dda9 c6dfb1e cbbda39 cfc01c7 c01f421 c286dd7 c2bd687 cfdce1d cfef18f c000b66 cf55a7b c514027"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452H17.21V14.86c0-1.333-.027-3.046-1.858-3.046-1.86.0-2.145 1.45-2.145 2.948v5.69H9.069V9h3.112v1.561h.044c.434-.82 1.494-1.686 3.074-1.686 3.29.0 3.897 2.165 3.897 4.983v6.594zM5.337 7.433a1.805 1.805.0 11-.002-3.61 1.805 1.805.0 01.002 3.61zM6.763 20.452H3.911V9h2.852v11.452z"/></svg>
<span class="cba5854">LinkedIn</span>
</a><a href=https://twitter.com/lbenicio_ target=_blank rel="noopener noreferrer" aria-label=Twitter class="c1d6c20 c7c11d8 c1d0018 cd1fd22 cb5c327 c10dda9 c6dfb1e cbbda39 cfc01c7 c01f421 c286dd7 c2bd687 cfdce1d cfef18f c000b66 cf55a7b c514027"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19.633 7.997c.013.177.013.354.013.53.0 5.386-4.099 11.599-11.6 11.599-2.31.0-4.457-.676-6.265-1.842.324.038.636.05.972.05 1.91.0 3.67-.65 5.07-1.755a4.099 4.099.0 01-3.827-2.84c.25.039.5.064.763.064.363.0.726-.051 1.065-.139A4.091 4.091.0 012.542 9.649v-.051c.538.3 1.162.482 1.824.507A4.082 4.082.0 012.54 6.7c0-.751.2-1.435.551-2.034a11.63 11.63.0 008.44 4.281 4.615 4.615.0 01-.101-.938 4.091 4.091.0 017.078-2.799 8.1 8.1.0 002.595-.988 4.112 4.112.0 01-1.8 2.261 8.2 8.2.0 002.357-.638A8.824 8.824.0 0119.613 7.96z"/></svg>
<span class="cba5854">Twitter</span></a></div></div></footer></body></html>